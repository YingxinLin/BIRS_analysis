<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Preliminary Analysis</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">BIRS analysis</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Overview</a>
</li>
<li>
  <a href="preliminary.html">Preliminary Analysis</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Preliminary Analysis</h1>

</div>


<div id="data" class="section level1">
<h1>Data</h1>
<pre class="r"><code>library(scater)
library(SingleCellExperiment)
library(ggthemes)
library(ggplot2)
library(ggridges)
library(plyr)
library(raster)
library(gridExtra)
library(sp)
library(spatstat)
library(uwot)
library(pheatmap)
source(&quot;functions/image_analysis_function.R&quot;)
set.seed(2020)</code></pre>
<div id="keren-et-al." class="section level2">
<h2>Keren et al.</h2>
<pre class="r"><code>load(&quot;../../sc-targeted-proteomics/data/mibiSCE.rda&quot;)
mibi.sce</code></pre>
<pre><code>## class: SingleCellExperiment 
## dim: 49 201656 
## metadata(0):
## assays(1): mibi_exprs
## rownames(49): C Na ... Ta Au
## rowData names(4): channel_name is_protein hgnc_symbol wagner_overlap
## colnames: NULL
## colData names(36): SampleID cellLabelInImage ...
##   Survival_days_capped_2016.1.1 Censored
## reducedDimNames(0):
## spikeNames(0):
## altExpNames(0):</code></pre>
<pre class="r"><code>cat(&quot;Patients information&quot;)</code></pre>
<pre><code>## Patients information</code></pre>
<pre class="r"><code>table(mibi.sce$SampleID)</code></pre>
<pre><code>## 
##    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15 
## 5167 3028 6315 6643 5406 5998 3410 3136 6139 4580 5112 6995 7665 6270 3315 
##   16   17   18   19   20   21   22   23   24   25   26   27   28   29   31 
## 8212 7071 5539 4400 5103 5423 3072 4490 4613 2658 5119 4332 6061 4819 3415 
##   32   33   34   35   36   37   38   39   40   41   42   43   44 
## 5158 2046 2856 7716 2939 6280 4330 4030 4285 4532 1380 1381 1217</code></pre>
<pre class="r"><code>cat(&quot;Cell types informaton&quot;)</code></pre>
<pre><code>## Cell types informaton</code></pre>
<pre class="r"><code># table(mibi.sce$tumor_group)
# table(mibi.sce$immune_group)

# rename the cell types
mibi.sce$cellTypes &lt;- ifelse(as.character(mibi.sce$immune_group) != &quot;not immune&quot;,
                             as.character(mibi.sce$immune_group),
                             as.character(mibi.sce$tumor_group))

table(mibi.sce$cellTypes)</code></pre>
<pre><code>## 
##                      B                    CD3                    CD4 
##                   9134                   3867                  12443 
##                    CD8                     DC                DC/Mono 
##                  15787                   1275                   5052 
##            Endothelial Keratin-positive tumor            Macrophages 
##                   2089                 102736                  20687 
##       Mesenchymal-like               Mono/Neu            Neutrophils 
##                   8479                   3113                   3020 
##                     NK           Other immune                  Tregs 
##                    674                   6943                   1341 
##                  Tumor           Unidentified 
##                   3177                   1839</code></pre>
<pre class="r"><code>mibi.sce$cellTypes_group &lt;- ifelse(as.character(mibi.sce$immune_group) != &quot;not immune&quot;,
                                   &quot;Micro-environment&quot;,
                                   &quot;Tumour&quot;)

selected_chanel_mibi &lt;- rownames(mibi.sce)[rowData(mibi.sce)$is_protein == 1]</code></pre>
<pre class="r"><code># color for mibi cell types
cellTypes_group_mibi_color &lt;- tableau_color_pal(&quot;Tableau 10&quot;)(length(unique(mibi.sce$cellTypes_group)))
cellTypes_group_mibi_color &lt;- c(cellTypes_group_mibi_color, &quot;black&quot;)
names(cellTypes_group_mibi_color) &lt;- c(unique(mibi.sce$cellTypes_group), &quot;Background&quot;)

cellTypes_mibi_color &lt;- tableau_color_pal(&quot;Classic 20&quot;)(length(unique(mibi.sce$cellTypes)))
cellTypes_mibi_color &lt;- c(cellTypes_mibi_color, &quot;black&quot;)
names(cellTypes_mibi_color) &lt;- c(unique(mibi.sce$cellTypes), &quot;Background&quot;)</code></pre>
<p>Visualising all cells using UMAP</p>
<pre class="r"><code>## Dimension Reduction using UMAP
mibi.sce &lt;- runUMAP(mibi.sce, exprs_values = &quot;mibi_exprs&quot;, 
                    feature_set = selected_chanel_mibi)
g1 &lt;- plotUMAP(mibi.sce, colour_by = &quot;cellTypes&quot;) +
  theme(aspect.ratio = 1)
g2 &lt;- plotUMAP(mibi.sce, colour_by = &quot;cellTypes_group&quot;) +
  theme(aspect.ratio = 1)
g3 &lt;- plotUMAP(mibi.sce, colour_by = &quot;SampleID&quot;) +
  theme(aspect.ratio = 1)

grid.arrange(g1, g2, g3, ncol = 2)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-5-1.png" width="1152" /></p>
<p>Cell type composition</p>
<pre class="r"><code>df_mibi &lt;- data.frame(colData(mibi.sce))

g1 &lt;- ggplot(df_mibi, aes(x = SampleID, fill = cellTypes)) +
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values = cellTypes_mibi_color) +
  theme(legend.position = &quot;right&quot;)

g2 &lt;- ggplot(df_mibi, aes(x = SampleID, fill = cellTypes_group)) +
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values = cellTypes_group_mibi_color) +
  theme(legend.position = &quot;right&quot;)

grid.arrange(g1, g2, ncol = 2)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-6-1.png" width="1152" /></p>
</div>
<div id="jackson-et-al." class="section level2">
<h2>Jackson et al.</h2>
<pre class="r"><code>source(&quot;basel_preprocessing.R&quot;)</code></pre>
<pre class="r"><code>sc_mat &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_sc_mat.rds&quot;)
pg &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_pg.rds&quot;)
meta &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_meta.rds&quot;)
selected_chanel &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_selected_chanel.rds&quot;)
dim(sc_mat)</code></pre>
<pre><code>## [1] 844498     64</code></pre>
<pre class="r"><code>sc_mat_norm &lt;- apply(sc_mat, 2, scale)</code></pre>
<pre class="r"><code>umap &lt;- uwot::umap(sc_mat_norm[, selected_chanel])
saveRDS(umap, file = &quot;../../sc-targeted-proteomics/output/basel_umap.rds&quot;)</code></pre>
<pre class="r"><code># color for mibi cell types

cellTypes_basel_color &lt;- sort(c(tableau_color_pal(&quot;Classic 20&quot;)(20),
                                tableau_color_pal(&quot;Summer&quot;)(5)))
cellTypes_basel_color &lt;- c(cellTypes_basel_color, &quot;black&quot;)
names(cellTypes_basel_color) &lt;- c(unique(pg$cluster_name), &quot;Background&quot;)</code></pre>
<p>Visualising all cells using UMAP</p>
<pre class="r"><code>basel_umap &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_umap.rds&quot;)
library(scattermore)

pg$UMAP1 &lt;- basel_umap[, 1]
pg$UMAP2 &lt;- basel_umap[, 2]
g1 &lt;- ggplot(pg, aes(x = UMAP1, y = UMAP2, color = cluster_name)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_manual(values = cellTypes_basel_color) +
  labs(color = &quot;Cell Type&quot;)
g1</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-11-1.png" width="1152" /></p>
<pre class="r"><code>g2 &lt;- ggplot(pg, aes(x = UMAP1, y = UMAP2, color = cluster_type)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_tableau() +
  labs(color = &quot;Cell Type&quot;)
g2</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-11-2.png" width="1152" /></p>
<p>Cell type composition</p>
<pre class="r"><code>df_basel &lt;- data.frame(pg)

g1 &lt;- ggplot(df_basel, aes(x = core, fill = cluster_name)) +
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values = cellTypes_basel_color) +
  theme(legend.position = &quot;right&quot;,
        axis.text.x = element_blank())
g1</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-12-1.png" width="1152" /></p>
<pre class="r"><code>g2 &lt;- ggplot(df_basel, aes(x = core, fill = cluster_type)) +
  geom_bar() +
  theme_bw() +
  scale_fill_tableau() +
  theme(legend.position = &quot;right&quot;,
        axis.text.x = element_blank())
g2</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-12-2.png" width="1152" /></p>
</div>
</div>
<div id="overlapped-features-between-two-datasets" class="section level1">
<h1>Overlapped features between two datasets</h1>
<pre class="r"><code># intersect(colnames(sc_mat), rownames(mibi.sce))
# colnames(sc_mat)[!colnames(sc_mat) %in% rownames(mibi.sce)]
rownames(mibi.sce)[!rownames(mibi.sce) %in% colnames(sc_mat)]</code></pre>
<pre><code>##  [1] &quot;C&quot;            &quot;Na&quot;           &quot;Si&quot;           &quot;P&quot;           
##  [5] &quot;Ca&quot;           &quot;Fe&quot;           &quot;dsDNA&quot;        &quot;Background&quot;  
##  [9] &quot;B7H3&quot;         &quot;FoxP3&quot;        &quot;Lag3&quot;         &quot;CD4&quot;         
## [13] &quot;CD16&quot;         &quot;CD56&quot;         &quot;OX40&quot;         &quot;PD1&quot;         
## [17] &quot;CD31&quot;         &quot;PD-L1&quot;        &quot;CD209&quot;        &quot;CD11c&quot;       
## [21] &quot;CD138&quot;        &quot;CD163&quot;        &quot;CSF-1R&quot;       &quot;CD8&quot;         
## [25] &quot;IDO&quot;          &quot;Keratin17&quot;    &quot;CD63&quot;         &quot;CD45RO&quot;      
## [29] &quot;Beta catenin&quot; &quot;HLA-DR&quot;       &quot;CD11b&quot;        &quot;H3K9ac&quot;      
## [33] &quot;Pan-Keratin&quot;  &quot;phospho-S6&quot;   &quot;MPO&quot;          &quot;Keratin6&quot;    
## [37] &quot;HLA_Class_1&quot;  &quot;Ta&quot;           &quot;Au&quot;</code></pre>
<pre class="r"><code>rownames(mibi.sce)[rownames(mibi.sce) == &quot;phospho-S6&quot;] &lt;- &quot;pS6&quot;
rownames(mibi.sce)[rownames(mibi.sce) == &quot;CD31&quot;] &lt;- &quot;vWF&quot;
rownames(mibi.sce)[rownames(mibi.sce) == &quot;Pan-Keratin&quot;] &lt;- &quot;panCK&quot;
common_anti &lt;- intersect(colnames(sc_mat), rownames(mibi.sce))
cat(&quot;Common protein between two datasets&quot;)</code></pre>
<pre><code>## Common protein between two datasets</code></pre>
<pre class="r"><code>common_anti</code></pre>
<pre><code>##  [1] &quot;EGFR&quot;     &quot;Ki67&quot;     &quot;SMA&quot;      &quot;Vimentin&quot; &quot;p53&quot;      &quot;panCK&quot;   
##  [7] &quot;CD20&quot;     &quot;vWF&quot;      &quot;H3K27me3&quot; &quot;CD45&quot;     &quot;CD68&quot;     &quot;CD3&quot;     
## [13] &quot;pS6&quot;</code></pre>
<pre class="r"><code>length(common_anti) </code></pre>
<pre><code>## [1] 13</code></pre>
<pre class="r"><code>mibi_exprs &lt;- assay(mibi.sce, &quot;mibi_exprs&quot;)
mibi_exprs_common &lt;- mibi_exprs[common_anti, ]
sc_mat_common &lt;- t(sc_mat_norm[, common_anti])</code></pre>
<pre class="r"><code>umap_common &lt;- uwot::umap(t(sc_mat_common))
saveRDS(umap_common, file = &quot;../../sc-targeted-proteomics/output/basel_umap_common.rds&quot;)

umap_mibi_common &lt;- uwot::umap(t(mibi_exprs_common))
saveRDS(umap_mibi_common, file = &quot;../../sc-targeted-proteomics/output/mibi_umap_common.rds&quot;)</code></pre>
<pre class="r"><code>basel_umap_common &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_umap_common.rds&quot;)

pg$UMAP1_common &lt;- basel_umap_common[, 1]
pg$UMAP2_common &lt;- basel_umap_common[, 2]
g1 &lt;- ggplot(pg, aes(x = UMAP1_common, y = UMAP2_common, color = cluster_name)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_manual(values = cellTypes_basel_color) +
  labs(color = &quot;Cell Type&quot;)
g1</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-16-1.png" width="1152" /></p>
<pre class="r"><code>g2 &lt;- ggplot(pg, aes(x = UMAP1_common, y = UMAP2_common, color = cluster_type)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_tableau() +
  labs(color = &quot;Cell Type&quot;)

g2</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-16-2.png" width="1152" /></p>
<pre class="r"><code>mibi_umap_common &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/mibi_umap_common.rds&quot;)

df_mibi$UMAP1_common &lt;- mibi_umap_common[, 1]
df_mibi$UMAP2_common &lt;- mibi_umap_common[, 2]
g1 &lt;- ggplot(df_mibi, aes(x = UMAP1_common, y = UMAP2_common, color = cellTypes)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_manual(values = cellTypes_mibi_color) +
  labs(color = &quot;Cell Type&quot;)
g1</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-17-1.png" width="1152" /></p>
<pre class="r"><code>g2 &lt;- ggplot(df_mibi, aes(x = UMAP1_common, y = UMAP2_common, color = cellTypes_group)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_tableau() +
  labs(color = &quot;Cell Type&quot;)

g2</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-17-2.png" width="1152" /></p>
</div>
<div id="spatial-pattern-analysis" class="section level1">
<h1>Spatial Pattern Analysis</h1>
<p>Here we will use two images from Keren et al. and Jackson et al. as examples to show the image extraction procedure (The full image extraction codes are provided in <code>mibi_spatial_analysis.R</code> and <code>basel_spatial_analysis.R</code>).</p>
<div id="keren-et-al.-1" class="section level2">
<h2>Keren et al.</h2>
<pre class="r"><code>tiff_name_list &lt;- list.files(&quot;../../sc-targeted-proteomics/data/TNBC_shareCellData/&quot;, pattern = &quot;.tiff&quot;)
tiff_name_list &lt;- tiff_name_list[-24] #filter p30

tiff_name_list</code></pre>
<pre><code>##  [1] &quot;p1_labeledcellData.tiff&quot;  &quot;p10_labeledcellData.tiff&quot;
##  [3] &quot;p11_labeledcellData.tiff&quot; &quot;p12_labeledcellData.tiff&quot;
##  [5] &quot;p13_labeledcellData.tiff&quot; &quot;p14_labeledcellData.tiff&quot;
##  [7] &quot;p15_labeledcellData.tiff&quot; &quot;p16_labeledcellData.tiff&quot;
##  [9] &quot;p17_labeledcellData.tiff&quot; &quot;p18_labeledcellData.tiff&quot;
## [11] &quot;p19_labeledcellData.tiff&quot; &quot;p2_labeledcellData.tiff&quot; 
## [13] &quot;p20_labeledcellData.tiff&quot; &quot;p21_labeledcellData.tiff&quot;
## [15] &quot;p22_labeledcellData.tiff&quot; &quot;p23_labeledcellData.tiff&quot;
## [17] &quot;p24_labeledcellData.tiff&quot; &quot;p25_labeledcellData.tiff&quot;
## [19] &quot;p26_labeledcellData.tiff&quot; &quot;p27_labeledcellData.tiff&quot;
## [21] &quot;p28_labeledcellData.tiff&quot; &quot;p29_labeledcellData.tiff&quot;
## [23] &quot;p3_labeledcellData.tiff&quot;  &quot;p31_labeledcellData.tiff&quot;
## [25] &quot;p32_labeledcellData.tiff&quot; &quot;p33_labeledcellData.tiff&quot;
## [27] &quot;p34_labeledcellData.tiff&quot; &quot;p35_labeledcellData.tiff&quot;
## [29] &quot;p36_labeledcellData.tiff&quot; &quot;p37_labeledcellData.tiff&quot;
## [31] &quot;p38_labeledcellData.tiff&quot; &quot;p39_labeledcellData.tiff&quot;
## [33] &quot;p4_labeledcellData.tiff&quot;  &quot;p40_labeledcellData.tiff&quot;
## [35] &quot;p41_labeledcellData.tiff&quot; &quot;p5_labeledcellData.tiff&quot; 
## [37] &quot;p6_labeledcellData.tiff&quot;  &quot;p7_labeledcellData.tiff&quot; 
## [39] &quot;p8_labeledcellData.tiff&quot;  &quot;p9_labeledcellData.tiff&quot;</code></pre>
<p>Here we are extracting the spatial pattern features from <code>p1_labeledcellData.tiff</code>.</p>
<pre class="r"><code>s &lt;- 1

str_name &lt;- paste(&quot;../../sc-targeted-proteomics/data/TNBC_shareCellData/&quot;, tiff_name_list[s], sep = &quot;&quot;)

sample_id &lt;- as.numeric(gsub(&quot;p&quot;, &quot;&quot;, gsub(&quot;_labeledcellData.tiff&quot;, &quot;&quot;, tiff_name_list[s])))

cat(paste0(&quot;Reading the tiff &quot;, print(tiff_name_list[s])))</code></pre>
<pre><code>## [1] &quot;p1_labeledcellData.tiff&quot;
## Reading the tiff p1_labeledcellData.tiff</code></pre>
<pre class="r"><code># read tiff data using raster
r &lt;- raster(str_name)
r</code></pre>
<pre><code>## class      : RasterLayer 
## dimensions : 2048, 2048, 4194304  (nrow, ncol, ncell)
## resolution : 1, 1  (x, y)
## extent     : 0, 2048, 0, 2048  (xmin, xmax, ymin, ymax)
## crs        : NA 
## source     : /Users/yingxinlin/Dropbox (Sydney Uni)/PhDProj/BANFF2020/sc-targeted-proteomics/data/TNBC_shareCellData/p1_labeledcellData.tiff 
## names      : p1_labeledcellData 
## values     : 0, 65535  (min, max)</code></pre>
<pre class="r"><code>p_sce &lt;- mibi.sce[, mibi.sce$SampleID == sample_id]


# matching the cell label in SingleCellExperiment with the raster position
cell_label &lt;- raster::values(r)
all_group_info &lt;- p_sce$cellTypes_group
notInLabel &lt;- unique(cell_label[!cell_label %in% p_sce$cellLabelInImage])
new_values &lt;- mapvalues((cell_label), from = notInLabel, to = rep(&quot;Background&quot;,
                                                                  length(notInLabel)))
new_values &lt;- mapvalues((new_values), from = p_sce$cellLabelInImage, to = all_group_info)


new_values_cellTypes &lt;- mapvalues((cell_label), from = notInLabel, to = rep(&quot;Background&quot;,
                                                                            length(notInLabel)))
new_values_cellTypes &lt;- mapvalues((new_values_cellTypes), from = p_sce$cellLabelInImage, to = p_sce$cellTypes)</code></pre>
<pre class="r"><code>ddf &lt;- rasterToPoints(r)
ddf &lt;- data.frame(ddf)
colnames(ddf) &lt;- c(&quot;X&quot;, &quot;Y&quot;, &quot;value&quot;)
ddf$cellType_group &lt;- new_values
ddf$cellType &lt;- new_values_cellTypes
g_cellGroup &lt;- ggplot(NULL) + 
  geom_raster(data = ddf, aes(X, Y, fill = as.factor(cellType_group))) +
  theme_minimal() +
  scale_fill_manual(values = cellTypes_group_mibi_color) +
  coord_quickmap() +
  theme(aspect.ratio = 1, legend.position = &quot;right&quot;) +
  labs(fill = &quot;Cell Type&quot;)

g_cellTypes &lt;- ggplot(NULL) + 
  geom_raster(data = ddf, aes(X, Y, fill = as.factor(cellType))) +
  theme_minimal() +
  scale_fill_manual(values = cellTypes_mibi_color) +
  coord_quickmap() +
  theme(aspect.ratio = 1, legend.position = &quot;right&quot;) +
  labs(fill = &quot;Cell Type&quot;)

grid.arrange(g_cellGroup, g_cellTypes, ncol = 2)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-20-1.png" width="1152" /></p>
<pre class="r"><code># extract the location and identify the cell centroid
coord_r &lt;- rasterToPoints(r)
center_r_x &lt;- aggregate(coord_r[, 1], list(coord_r[, 3]), median)
group &lt;- center_r_x$Group.1
center_r_x &lt;- center_r_x$x
center_r_y &lt;- aggregate(coord_r[, 2], list(coord_r[, 3]), median)$x
center_r &lt;- data.frame(x = center_r_x, y = center_r_y, group = group)



## maping the cell types to the raster
r_cellType_group &lt;- mapvalues((center_r$group), from = notInLabel, to = rep(0, length(notInLabel)))
r_cellType_group &lt;- mapvalues((r_cellType_group), from = p_sce$cellLabelInImage, to = all_group_info)

center_r$cellTypes &lt;- r_cellType_group

r_cellType &lt;- mapvalues((center_r$group), from = notInLabel, to = rep(0, length(notInLabel)))
r_cellType &lt;- mapvalues((r_cellType), from = p_sce$cellLabelInImage, to = p_sce$cellTypes)

center_r$cellTypes2 &lt;- r_cellType

# filter the center info without cells 
center_r &lt;- center_r[center_r$cellTypes != &quot;0&quot;, ]



r_cellType_group &lt;- mapvalues((center_r$group), 
                              from = notInLabel, 
                              to = rep(0, length(notInLabel)))

exprsMat &lt;- assay(p_sce, &quot;mibi_exprs&quot;)
exprsMat_map &lt;- sapply(rownames(exprsMat), function(x) {
  zero_one_scale(mapvalues((r_cellType_group), 
                           from = p_sce$cellLabelInImage, 
                           to = exprsMat[x, ]))
  
})</code></pre>
<pre class="r"><code># create ppp object and extract spatial features
cell_points &lt;- ppp(x = center_r[, 1], y = center_r[, 2], check = FALSE,
                   yrange = c(0, 2048), xrange = c(0, 2048),
                   marks = as.factor(center_r$cellTypes))


plot(density(split(cell_points), sigma = 20), ribbon = FALSE)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-22-1.png" width="1152" /></p>
<pre class="r"><code>idx &lt;- center_r$cellTypes == &quot;Tumour&quot;
cell_points_tumour &lt;- ppp(x = center_r[idx, 1], y = center_r[idx, 2], check = FALSE,
                          yrange = c(0, 2048), xrange = c(0, 2048))

idx &lt;- center_r$cellTypes == &quot;Micro-environment&quot;
cell_points_immune &lt;- ppp(x = center_r[idx, 1], y = center_r[idx, 2], check = FALSE,
                          yrange = c(0, 2048), xrange = c(0, 2048))



ann_tumour_k1 &lt;- mean(nndist(cell_points_tumour, k = 1))
ann_tumour_k3 &lt;- mean(nndist(cell_points_tumour, k = 3))
ann_tumour_k5 &lt;- mean(nndist(cell_points_tumour, k = 5))
ann_tumour_k10 &lt;- mean(nndist(cell_points_tumour, k = 10))

ann_immune_k1 &lt;- mean(nndist(cell_points_immune, k = 1))
ann_immune_k3 &lt;- mean(nndist(cell_points_immune, k = 3))
ann_immune_k5 &lt;- mean(nndist(cell_points_immune, k = 5))
ann_immune_k10 &lt;- mean(nndist(cell_points_immune, k = 10))


E_pcf_cross &lt;- envelope(cell_points, pcfcross, nsim = 100, 
                        correction = &quot;Ripley&quot;, savefuns = T,
                        global = TRUE,
                        r = seq(0,250, 10))</code></pre>
<pre><code>## Generating 100 simulations of CSR  ...
## 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39,
## 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78,
## 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,  100.
## 
## Done.</code></pre>
<pre class="r"><code>E_pcf_tumour &lt;- envelope(cell_points[cell_points$marks == &#39;Tumour&#39;], pcf, nsim = 100, 
                         correction = &quot;Ripley&quot;, savefuns = T,
                         global = TRUE,
                         r = seq(0,250, 10))</code></pre>
<pre><code>## Generating 100 simulations of CSR  ...
## 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39,
## 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78,
## 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,  100.
## 
## Done.</code></pre>
<pre class="r"><code>E_pcf_immune &lt;- envelope(cell_points[cell_points$marks == &quot;Micro-environment&quot;], pcf, nsim = 100, 
                         correction = &quot;Ripley&quot;, savefuns = T,
                         global = TRUE,
                         r = seq(0,250, 10))</code></pre>
<pre><code>## Generating 100 simulations of CSR  ...
## 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39,
## 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78,
## 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,  100.
## 
## Done.</code></pre>
<p>Patial correlation function for tumour-tumour cells, immune-immune cells and tumour-immune cells</p>
<pre class="r"><code>par(mfrow = c(2, 2))
plot(E_pcf_tumour)
plot(E_pcf_immune)
plot(E_pcf_cross)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-23-1.png" width="1152" /></p>
<p>The above plot indicates the pairwise correlation function (pcf) of distance for point patterns in terms of (i) tumour cells, (ii) immune cells, (iii) tumour-immune cells. The grey area here indicates a null distribution generated by permutations. For a certain radius r and the point from the same cell type, a pcf value higher than upper critical boundary of the gray area are indicates that the points are significantly distributed in clusters, while than the lower boundary of the grey area indicates the dispersed distribution of the points. For the values that are within the grey area, it indicates the points are spatially randomlly distributed. On the other hand, when we comparing the points from two different types, a larger pcf values indicates the two types of points are attracted, and a lower pcf values indicate the points are repulsed.</p>
<p>We can see for this sample, Tumour cells are more likely randomly distributed in spatial context, while immune cells are located as clusters. And the tumour and immune cells are repulsed to each other.</p>
<pre class="r"><code>pcf_results &lt;- c(extract_pcf_results(E_pcf_cross, &quot;cross&quot;),
                 extract_pcf_results(E_pcf_tumour, &quot;tumour&quot;),
                 extract_pcf_results(E_pcf_immune, &quot;immune&quot;))

library(SpatEntropy)
shZ &lt;- shannonX(marks(cell_points))</code></pre>
<pre><code>## [1] &quot;data must be a matrix or a vector&quot;</code></pre>
<pre class="r"><code>#Leibovici’s entropy
dmat &lt;- pairdist(cell_points)
dmat[lower.tri(dmat,diag = TRUE)] &lt;- NA
adjmat &lt;- adj_mat(dmat, dd0 = 0, dd1 = 20)
leib &lt;- leibovici(marks(cell_points), adjmat, ordered = TRUE)

leib_freq &lt;- leib$freq.table$proportion
names(leib_freq) &lt;- paste(&quot;leib&quot;, leib$freq.table$couple, &quot;freq&quot;, sep = &quot;_&quot;)
leib_entro &lt;- leib$entropy
names(leib_entro) &lt;- &quot;leib_entropy&quot;

intensity_res &lt;- intensity(cell_points)
names(intensity_res) &lt;- paste(&quot;intensity&quot;, names(intensity_res))


marks(cell_points) &lt;- center_r$cellTypes2
#Leibovici’s entropy
dmat &lt;- pairdist(cell_points)
dmat[lower.tri(dmat,diag = TRUE)] &lt;- NA
adjmat &lt;- adj_mat(dmat, dd0 = 0, dd1 = 20)
leib &lt;- leibovici(marks(cell_points), adjmat, ordered = TRUE)
leib_entro2 &lt;- leib$entropy
names(leib_entro2) &lt;- &quot;leib_entropy_cellTypes&quot;




res_image &lt;- c(intensity_res, shannon = shZ$shannon, leib_entro, leib_entro2, 
               pcf_results,
               ann_tumour_k1 = ann_tumour_k1, ann_tumour_k3 = ann_tumour_k3, 
               ann_tumour_k5 = ann_tumour_k5, ann_tumour_k10 = ann_tumour_k10,
               ann_immune_k1 = ann_immune_k1, ann_immune_k3 = ann_immune_k3, 
               ann_immune_k5 = ann_immune_k5, ann_immune_k10 = ann_immune_k10)

cat(paste0(&quot;Features extracted for&quot;, tiff_name_list[s]))</code></pre>
<pre><code>## Features extracted forp1_labeledcellData.tiff</code></pre>
<pre class="r"><code>round(res_image, 2)</code></pre>
<pre><code>## intensity Micro-environment            intensity Tumour 
##                        0.00                        0.00 
##                     shannon                leib_entropy 
##                        0.69                        1.00 
##      leib_entropy_cellTypes               cross_max_pcf 
##                        3.11                        0.83 
##                 cross_max_r               cross_max_sig 
##                      240.00                       -1.00 
##               cross_r50_pcf           cross_r50_pcf_sig 
##                        0.75                       -1.00 
##              cross_r100_pcf          cross_r100_pcf_sig 
##                        0.78                       -1.00 
##              cross_r150_pcf          cross_r150_pcf_sig 
##                        0.79                       -1.00 
##              cross_r200_pcf          cross_r200_pcf_sig 
##                        0.81                       -1.00 
##              tumour_max_pcf                tumour_max_r 
##                        1.24                       30.00 
##              tumour_max_sig              tumour_r50_pcf 
##                        1.00                        1.10 
##          tumour_r50_pcf_sig             tumour_r100_pcf 
##                        0.00                        1.09 
##         tumour_r100_pcf_sig             tumour_r150_pcf 
##                        0.00                        1.08 
##         tumour_r150_pcf_sig             tumour_r200_pcf 
##                        0.00                        1.07 
##         tumour_r200_pcf_sig              immune_max_pcf 
##                        0.00                        3.14 
##                immune_max_r              immune_max_sig 
##                       20.00                        1.00 
##              immune_r50_pcf          immune_r50_pcf_sig 
##                        2.24                        1.00 
##             immune_r100_pcf         immune_r100_pcf_sig 
##                        2.08                        1.00 
##             immune_r150_pcf         immune_r150_pcf_sig 
##                        1.98                        1.00 
##             immune_r200_pcf         immune_r200_pcf_sig 
##                        1.88                        1.00 
##               ann_tumour_k1               ann_tumour_k3 
##                       25.00                       38.05 
##               ann_tumour_k5              ann_tumour_k10 
##                       49.00                       69.67 
##               ann_immune_k1               ann_immune_k3 
##                       20.25                       32.76 
##               ann_immune_k5              ann_immune_k10 
##                       43.27                       62.85</code></pre>
</div>
<div id="jackson-et-al.-1" class="section level2">
<h2>Jackson et al.</h2>
<p>The similar analysis for Jackson et al. Basel cohort</p>
<pre class="r"><code>pg$cluster_type2 &lt;- pg$cluster_type
pg$cluster_type2[pg$cluster_type2 %in% c(&quot;Endothelial&quot;, &quot;Stromal&quot;, &quot;Immune&quot;)] &lt;- &quot;Micro-environment&quot;
pg$cluster_type2[pg$cluster_type2 %in% c(&quot;Epithelial&quot;)] &lt;- &quot;Tumour&quot;
table(pg$cluster_type2)</code></pre>
<pre><code>## 
## Micro-environment            Tumour 
##            401634            442864</code></pre>
<pre class="r"><code>cellTypes_group_basel_color &lt;- tableau_color_pal(&quot;Tableau 10&quot;)(length(unique(pg$cluster_type2)))
cellTypes_group_basel_color &lt;- c(cellTypes_group_basel_color, &quot;black&quot;)
names(cellTypes_group_basel_color) &lt;- c(unique(pg$cluster_type2), &quot;Background&quot;)</code></pre>
<pre class="r"><code>tiff_name_list &lt;- list.files(&quot;../../sc-targeted-proteomics/data/Nature_cytof/OMEnMasks/Basel_Zuri_masks/&quot;, pattern = &quot;Basel&quot;)
map_names &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_map_file_core_names.rds&quot;)


filter_idx &lt;- c(93, 106, 107, 238, 251, 370, 371)

tiff_name_list &lt;- tiff_name_list[-filter_idx]

s &lt;- 333
str_name &lt;- paste(&quot;../../sc-targeted-proteomics/data/Nature_cytof/OMEnMasks/Basel_Zuri_masks/&quot;, 
                  tiff_name_list[s], sep = &quot;&quot;)

r &lt;- raster(str_name)
cell_label &lt;- raster::values(r)

ncells &lt;- length(unique(cell_label)) - 1

sample_id &lt;- names(which(map_names[, 2] == tiff_name_list[s]))

idx &lt;- which(pg$core == sample_id)

pg_sub &lt;- pg[idx, ]
sc_mat_subset &lt;- sc_mat[idx, ]</code></pre>
<pre class="r"><code>all_group_info &lt;- pg_sub$cluster_type2

cell_label &lt;- mapvalues(cell_label, 
                        from = sort(unique(cell_label[cell_label != 0])),
                        to = seq_len(length(unique(cell_label[cell_label != 0]))))
values(r) &lt;- cell_label

new_values &lt;- mapvalues(cell_label, from = 0, to = &quot;Background&quot;)

new_values &lt;- mapvalues(new_values, from = seq_len(length(unique(cell_label[cell_label != 0]))), to = all_group_info)


ddf &lt;- rasterToPoints(r)
ddf &lt;- data.frame(ddf)
colnames(ddf) &lt;- c(&quot;X&quot;, &quot;Y&quot;, &quot;value&quot;)
ddf$cellType &lt;- new_values
g_cellTypes &lt;- ggplot(NULL) + 
  geom_raster(data = ddf, aes(X, Y, fill = as.factor(cellType))) +
  theme_minimal() +
  scale_fill_manual(values = cellTypes_group_basel_color) +
  coord_quickmap() +
  theme(aspect.ratio = 1) +
  labs(fill = &quot;Cell Type&quot;)



new_values2 &lt;- mapvalues(cell_label, from = 0, to = &quot;Background&quot;)

new_values2 &lt;- mapvalues(new_values2, from = seq_len(length(unique(cell_label[cell_label != 0]))), to = pg_sub$cluster_name)


ddf$cellType2 &lt;- new_values2
g_cellTypes2 &lt;- ggplot(NULL) + 
  geom_raster(data = ddf, aes(X, Y, fill = as.factor(cellType2))) +
  theme_minimal() +
  scale_fill_manual(values = cellTypes_basel_color) +
  coord_quickmap() +
  theme(aspect.ratio = 1) +
  labs(fill = &quot;Cell Type&quot;)


grid.arrange(g_cellTypes, g_cellTypes2, nrow = 2)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-27-1.png" width="1152" /></p>
<pre class="r"><code>coord_r &lt;- rasterToPoints(r)
center_r_x &lt;- aggregate(coord_r[, 1], list(coord_r[, 3]), median)
group &lt;- center_r_x$Group.1
center_r_x &lt;- center_r_x$x
center_r_y &lt;- aggregate(coord_r[, 2], list(coord_r[, 3]), median)$x

center_r &lt;- data.frame(x = center_r_x, y = center_r_y, group = group)


center_r &lt;- center_r[center_r$group != 0, ]

center_r$cellTypes &lt;- pg_sub$cluster_type2

center_r$cellTypes2 &lt;- pg_sub$cluster_type


library(sf)
library(maptools)


cell_points &lt;- ppp(x = center_r[, 1], y = center_r[, 2], check = FALSE,
                   yrange = c(0, round(max(coord_r[, 2]))), 
                   xrange = c(0, round(max(coord_r[, 1]))),
                   marks = as.factor(center_r$cellTypes))



plot(density(split(cell_points), sigma = 20), ribbon = FALSE)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-28-1.png" width="1152" /></p>
<pre class="r"><code>idx &lt;- center_r$cellTypes == &quot;Tumour&quot;
cell_points_tumour &lt;- ppp(x = center_r[idx, 1], y = center_r[idx, 2], check = FALSE,
                          yrange = c(0, round(max(coord_r[, 2]))), 
                          xrange = c(0, round(max(coord_r[, 1]))))

idx &lt;- center_r$cellTypes == &quot;Micro-environment&quot;
cell_points_immune &lt;- ppp(x = center_r[idx, 1], y = center_r[idx, 2], check = FALSE,
                          yrange = c(0, round(max(coord_r[, 2]))), 
                          xrange = c(0, round(max(coord_r[, 1]))))

ann_tumour_k1 &lt;- mean(nndist(cell_points_tumour, k = 1))
ann_tumour_k3 &lt;- mean(nndist(cell_points_tumour, k = 3))
ann_tumour_k5 &lt;- mean(nndist(cell_points_tumour, k = 5))
ann_tumour_k10 &lt;- mean(nndist(cell_points_tumour, k = 10))

ann_immune_k1 &lt;- mean(nndist(cell_points_immune, k = 1))
ann_immune_k3 &lt;- mean(nndist(cell_points_immune, k = 3))
ann_immune_k5 &lt;- mean(nndist(cell_points_immune, k = 5))
ann_immune_k10 &lt;- mean(nndist(cell_points_immune, k = 10))


E_pcf_cross &lt;- envelope(cell_points, pcfcross, nsim = 100, 
                        correction = &quot;Ripley&quot;, savefuns = T,
                        global = TRUE,
                        r = seq(0,250, 10))</code></pre>
<pre><code>## Generating 100 simulations of CSR  ...
## 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39,
## 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78,
## 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,  100.
## 
## Done.</code></pre>
<pre class="r"><code>E_pcf_tumour &lt;- envelope(cell_points[cell_points$marks==&#39;Tumour&#39;], pcf, nsim = 100, 
                         correction = &quot;Ripley&quot;, savefuns = T,
                         global = TRUE,
                         r = seq(0,250, 10))</code></pre>
<pre><code>## Generating 100 simulations of CSR  ...
## 1, 2,  [etd 3:33] 3,  [etd 3:18] 4,
##  [etd 3:06] 5,  [etd 3:13] 6,  [etd 3:11] 7,  [etd 3:01] 8,
##  [etd 3:01] 9,  [etd 2:54] 10,  [etd 2:48] 11,  [etd 2:52] 12,
##  [etd 2:49] 13,  [etd 2:46] 14,  [etd 2:46] 15,  [etd 2:43] 16,
##  [etd 2:50] 17,  [etd 2:45] 18,  [etd 2:55] 19,  [etd 2:52] 20,
##  [etd 2:48] 21,  [etd 2:43] 22,  [etd 2:41] 23,  [etd 2:37] 24,
##  [etd 2:34] 25,  [etd 2:31] 26,  [etd 2:28] 27,  [etd 2:26] 28,
##  [etd 2:23] 29,  [etd 2:21] 30,  [etd 2:20] 31,  [etd 2:17] 32,
##  [etd 2:14] 33,  [etd 2:12] 34,  [etd 2:10] 35,  [etd 2:09] 36,
##  [etd 2:06] 37,  [etd 2:04] 38,  [etd 2:04] 39,  [etd 2:02] 40,
##  [etd 1:59] 41,  [etd 1:56] 42,  [etd 1:54] 43,  [etd 1:51] 44,
##  [etd 1:48] 45,  [etd 1:46] 46,  [etd 1:44] 47,  [etd 1:41] 48,
##  [etd 1:39] 49,  [etd 1:37] 50,  [etd 1:35] 51,  [etd 1:33] 52,
##  [etd 1:32] 53,  [etd 1:29] 54,  [etd 1:27] 55,  [etd 1:25] 56,
##  [etd 1:23] 57,  [etd 1:21] 58,  [etd 1:20] 59,  [etd 1:18] 60,
##  [etd 1:15] 61,  [etd 1:14] 62,  [etd 1:11] 63,  [etd 1:09] 64,
##  [etd 1:07] 65,  [etd 1:05] 66,  [etd 1:03] 67,  [etd 1:01] 68,
##  [etd 59 sec] 69,  [etd 57 sec] 70,  [etd 56 sec] 71,  [etd 53 sec] 72,
##  [etd 52 sec] 73,  [etd 50 sec] 74,  [etd 48 sec] 75,  [etd 46 sec] 76,
##  [etd 44 sec] 77,  [etd 42 sec] 78,  [etd 40 sec] 79,  [etd 38 sec] 80,
##  [etd 37 sec] 81,  [etd 35 sec] 82,  [etd 33 sec] 83,  [etd 31 sec] 84,
##  [etd 29 sec] 85,  [etd 27 sec] 86,  [etd 25 sec] 87,  [etd 23 sec] 88,
##  [etd 22 sec] 89,  [etd 20 sec] 90,  [etd 18 sec] 91,  [etd 16 sec] 92,
##  [etd 14 sec] 93,  [etd 13 sec] 94,  [etd 11 sec] 95,  [etd 9 sec] 96,
##  [etd 7 sec] 97,  [etd 5 sec] 98,  [etd 4 sec] 99,  [etd 2 sec]  100.
## 
## Done.</code></pre>
<pre class="r"><code>E_pcf_immune &lt;-envelope(cell_points[cell_points$marks==&quot;Micro-environment&quot;], pcf, nsim = 100, 
                        correction = &quot;Ripley&quot;, savefuns = T,
                        global = TRUE,
                        r = seq(0,250, 10))</code></pre>
<pre><code>## Generating 100 simulations of CSR  ...
## 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39,
## 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78,
## 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,  100.
## 
## Done.</code></pre>
<pre class="r"><code>par(mfrow = c(2, 2))
plot(E_pcf_tumour)
plot(E_pcf_immune)
plot(E_pcf_cross)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-29-1.png" width="1152" /> We can see for this sample, both tumour cells and immune cells are only forming clusters within a small r, and are randomly spatially distrubted for a larger r. And the tumour and immune cells are spatially independent of each other.</p>
<pre class="r"><code>pcf_results &lt;- c(extract_pcf_results(E_pcf_cross, &quot;cross&quot;),
                 extract_pcf_results(E_pcf_tumour, &quot;tumour&quot;),
                 extract_pcf_results(E_pcf_immune, &quot;immune&quot;))

library(SpatEntropy)
shZ &lt;- shannonX(marks(cell_points))</code></pre>
<pre><code>## [1] &quot;data must be a matrix or a vector&quot;</code></pre>
<pre class="r"><code>#Leibovici’s entropy
dmat &lt;- pairdist(cell_points)
dmat[lower.tri(dmat,diag = TRUE)] &lt;- NA
adjmat &lt;- adj_mat(dmat, dd0 = 0, dd1 = 20)
leib &lt;- leibovici(marks(cell_points), adjmat, ordered=T)

leib_freq &lt;- leib$freq.table$proportion
names(leib_freq) &lt;- paste(&quot;leib&quot;, leib$freq.table$couple, &quot;freq&quot;, sep = &quot;_&quot;)
leib_entro &lt;- leib$entropy
names(leib_entro) &lt;- &quot;leib_entropy&quot;

intensity_res &lt;- intensity(cell_points)
if (length(intensity_res) &lt; 2) {
  tab &lt;- table(marks(cell_points))
  max_name &lt;- names(tab)[which.max(tab)]
  min_name &lt;- names(tab)[which.min(tab)]
  intensity_res &lt;- c(intensity_res, 0)
  names(intensity_res) &lt;- c(paste(&quot;intensity&quot;, max_name),
                            paste(&quot;intensity&quot;, min_name))
  
} else {
  names(intensity_res) &lt;- paste(&quot;intensity&quot;, names(intensity_res))
}



marks(cell_points) &lt;- center_r$cellTypes
#Leibovici’s entropy
dmat &lt;- pairdist(cell_points)
dmat[lower.tri(dmat,diag = TRUE)] &lt;- NA
adjmat &lt;- adj_mat(dmat, dd0 = 0, dd1 = 20)
leib &lt;- leibovici(marks(cell_points), adjmat, ordered=T)
leib_entro2 &lt;- leib$entropy
names(leib_entro2) &lt;- &quot;leib_entropy_cellTypes&quot;




res_image &lt;- c(intensity_res, shannon = shZ$shannon, leib_entro, leib_entro2, 
               pcf_results,
               ann_tumour_k1 = ann_tumour_k1, ann_tumour_k3 = ann_tumour_k3, 
               ann_tumour_k5 = ann_tumour_k5, ann_tumour_k10 = ann_tumour_k10,
               ann_immune_k1 = ann_immune_k1, ann_immune_k3 = ann_immune_k3, 
               ann_immune_k5 = ann_immune_k5, ann_immune_k10 = ann_immune_k10)
round(res_image, 3)</code></pre>
<pre><code>## intensity Micro-environment            intensity Tumour 
##                       0.002                       0.003 
##                     shannon                leib_entropy 
##                       0.649                       1.232 
##      leib_entropy_cellTypes               cross_max_pcf 
##                       1.232                       1.034 
##                 cross_max_r               cross_max_sig 
##                      30.000                       0.000 
##               cross_r50_pcf           cross_r50_pcf_sig 
##                       0.994                       0.000 
##              cross_r100_pcf          cross_r100_pcf_sig 
##                       0.987                       0.000 
##              cross_r150_pcf          cross_r150_pcf_sig 
##                       0.979                       0.000 
##              cross_r200_pcf          cross_r200_pcf_sig 
##                       0.989                       0.000 
##              tumour_max_pcf                tumour_max_r 
##                       1.819                      10.000 
##              tumour_max_sig              tumour_r50_pcf 
##                       1.000                       1.085 
##          tumour_r50_pcf_sig             tumour_r100_pcf 
##                       0.000                       1.038 
##         tumour_r100_pcf_sig             tumour_r150_pcf 
##                       0.000                       1.030 
##         tumour_r150_pcf_sig             tumour_r200_pcf 
##                       0.000                       1.048 
##         tumour_r200_pcf_sig              immune_max_pcf 
##                       0.000                       1.517 
##                immune_max_r              immune_max_sig 
##                      10.000                       1.000 
##              immune_r50_pcf          immune_r50_pcf_sig 
##                       1.026                       0.000 
##             immune_r100_pcf         immune_r100_pcf_sig 
##                       1.008                       0.000 
##             immune_r150_pcf         immune_r150_pcf_sig 
##                       1.014                       0.000 
##             immune_r200_pcf         immune_r200_pcf_sig 
##                       0.980                       0.000 
##               ann_tumour_k1               ann_tumour_k3 
##                      10.366                      15.495 
##               ann_tumour_k5              ann_tumour_k10 
##                      20.525                      29.796 
##               ann_immune_k1               ann_immune_k3 
##                      11.965                      21.791 
##               ann_immune_k5              ann_immune_k10 
##                      29.106                      43.091</code></pre>
</div>
</div>
<div id="image-features" class="section level1">
<h1>Image features</h1>
<p>Combine the spatial features from two datasets</p>
<pre class="r"><code>image_features &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_image_features.rds&quot;)
image_features_mibi &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/mibi_image_features_forSurv.rds&quot;)
meta_mibi &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/mibi_meta_forSurv.rds&quot;)

meta_filter &lt;- meta[meta$core %in% rownames(image_features), ]
image_features &lt;- image_features
image_features[is.infinite(image_features)] &lt;- 0
# we will only keep the data with more than 1000 celss
tab_core &lt;- table(pg$core)
core_to_keep &lt;- names(tab_core)[which(tab_core &gt;= 1000)]
image_features_subset &lt;- image_features[core_to_keep, ]
meta_filter &lt;- meta[meta$core %in% core_to_keep, ]


# for patient with more than 1 sample, 
# we will only keep the sample with more cells *for now*
multi_sample_pid &lt;- names(which(table(meta_filter$PID) &gt; 1))
not_keep &lt;- c()
for (i in 1:length(multi_sample_pid)) {
  tab_tmp &lt;- tab_core[meta_filter[meta_filter$PID == multi_sample_pid[i],]$core]
  not_keep &lt;- append(not_keep, names(tab_tmp)[-which.max(tab_tmp)])
}

meta_filter &lt;- meta_filter[!meta_filter$core %in% not_keep, ]
image_features_subset &lt;- image_features_subset[!rownames(image_features_subset) %in% not_keep, ]



# combine two image features
image_features_comb &lt;- rbind(image_features_subset, image_features_mibi)


dataset &lt;- c(rep(&quot;Basel&quot;, nrow(image_features_subset)),
             rep(&quot;MIBI&quot;, nrow(image_features_mibi)))

rownames(image_features_comb) &lt;- paste(dataset, rownames(image_features_comb), sep = &quot;_&quot;)

# scale the features within each dataset, and recombine them
image_features_combine_scale &lt;- rbind(apply(image_features_subset[, !grepl(&quot;max_sig|pcf_sig|max_r&quot;, colnames(image_features_subset))]
                                            , 2, zero_one_scale),
                                      apply(image_features_mibi[, !grepl(&quot;max_sig|pcf_sig|max_r&quot;, colnames(image_features_subset))]
                                            , 2, zero_one_scale))

rownames(image_features_combine_scale) &lt;- rownames(image_features_comb)</code></pre>
<p>Clustering on the spatial features using hierarchical clustering</p>
<pre class="r"><code>hclust_res &lt;- hclust(dist(image_features_combine_scale), 
                     method = &quot;ward.D2&quot;)

hclust_cluster &lt;- cutree(hclust_res, k = 5)


names(hclust_cluster) &lt;- rownames(image_features_comb)
table(hclust_cluster, dataset)</code></pre>
<pre><code>##               dataset
## hclust_cluster Basel MIBI
##              1    97    0
##              2    91    0
##              3    63    4
##              4     9   11
##              5     0   25</code></pre>
<p>Heatmap of the spatial features</p>
<pre class="r"><code>col_anno &lt;- data.frame(cluster = as.factor(hclust_cluster),
                       dataset = dataset)
rownames(col_anno) &lt;- rownames(image_features_combine_scale)

color_anno &lt;- list(cluster = tableau_color_pal(&quot;Tableau 10&quot;)(10),
                   dataset = tableau_color_pal(&quot;Classic 10&quot;)(2))
names(color_anno$cluster) &lt;- levels(col_anno$cluster)
names(color_anno$dataset) &lt;- levels(col_anno$dataset)


p &lt;- pheatmap(image_features_combine_scale, 
              clustering_method = &quot;ward.D2&quot;,
              annotation_row = col_anno,
              annotation_colors = color_anno,
              show_rownames = FALSE)
show(p)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-33-1.png" width="1152" /></p>
</div>
<div id="survival-analysis" class="section level1">
<h1>Survival analysis</h1>
<p>In this section, we will analysis the survival of the five spatial subtypes we identified from the previous section.</p>
<pre class="r"><code>library(stringr)
library(survival)
library(survminer)
library(RColorBrewer)</code></pre>
<pre class="r"><code># survival data for Keren et al.
surv_dat_mibi &lt;- cbind(meta_mibi[, c(&#39;SampleID&#39;, 
                                     &#39;Survival_days_capped_2016.1.1&#39;,
                                     &#39;Censored&#39;)])

colnames(surv_dat_mibi) &lt;- c(&quot;PID&quot;, &quot;SurvivalDays&quot;, &quot;Censored&quot;)

surv_dat_mibi$PID_dataset &lt;- paste(&quot;MIBI&quot;, surv_dat_mibi$PID, sep = &quot;_&quot;)
surv_dat_mibi$clinical_type &lt;- &quot;TripleNeg&quot;
surv_dat_mibi$SurvivalYears &lt;- surv_dat_mibi$SurvivalDays/365
surv_dat_mibi$Dataset &lt;- &quot;MIBI&quot;

# survival data for Jackson et al.
surv_dat_basel &lt;- meta_filter[, c(&#39;core&#39;, &#39;OSmonth&#39;,&#39;Patientstatus&#39;,&#39;clinical_type&#39;)]
surv_dat_basel$PID_dataset &lt;- paste(&quot;Basel&quot;, surv_dat_basel$core, sep = &quot;_&quot;)
surv_dat_basel$Censored[str_detect(surv_dat_basel$Patientstatus,&#39;death by primary disease|death&#39;)] &lt;- 1
surv_dat_basel$Censored[is.na(surv_dat_basel$Censored)] &lt;- 0
surv_dat_basel$SurvivalYears &lt;- surv_dat_basel$OSmonth/12
surv_dat_basel$Dataset &lt;- &quot;Basel&quot;

surv_dat_combine &lt;- rbind(surv_dat_basel[, c(&quot;PID_dataset&quot;, &quot;clinical_type&quot;, 
                                             &quot;Censored&quot;, &quot;SurvivalYears&quot;, &quot;Dataset&quot;)],
                          surv_dat_mibi[, c(&quot;PID_dataset&quot;, &quot;clinical_type&quot;, 
                                            &quot;Censored&quot;, &quot;SurvivalYears&quot;, &quot;Dataset&quot;)])
surv_dat_combine$cluster &lt;- hclust_cluster[surv_dat_combine$PID_dataset]

SurvObj_combine &lt;- Surv(surv_dat_combine$SurvivalYears, surv_dat_combine$Censored)
surv_by_cluster &lt;- survfit(SurvObj_combine ~ surv_dat_combine$cluster)
surv_by_clinical_cluster &lt;- survfit(SurvObj_combine ~ surv_dat_combine$cluster + surv_dat_combine$clinical_type)

ggsurvplot(surv_by_cluster, 
           data = surv_dat_combine,
           size = 1,                 # change line size
           palette = tableau_color_pal(&quot;Tableau 10&quot;)(10),# custom color palettes
           # conf.int = TRUE,          # Add confidence interval
           pval = TRUE,              # Add p-value
           risk.table = TRUE,        # Add risk table
           risk.table.col = &quot;strata&quot;,# Risk table color by groups
           risk.table.height = 0.25, # Useful to change when you have multiple groups
           ggtheme = theme_bw()      # Change ggplot2 theme
)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-35-1.png" width="1152" /></p>
<pre class="r"><code>ggsurvplot(surv_by_clinical_cluster, 
           data = surv_dat_combine,
           size = 1,                 # change line size
           # palette = tableau_color_pal(&quot;Tableau 10&quot;)(10),# custom color palettes
           # conf.int = TRUE,          # Add confidence interval
           pval = TRUE,              # Add p-value
           risk.table = TRUE,        # Add risk table
           risk.table.col = &quot;strata&quot;,# Risk table color by groups
           risk.table.height = 0.25, # Useful to change when you have multiple groups
           ggtheme = theme_bw()      # Change ggplot2 theme
)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-35-2.png" width="1152" /></p>
<div id="survival-analysis-for-triple-negative-breast-cancer" class="section level2">
<h2>Survival analysis for triple negative breast cancer</h2>
<pre class="r"><code>surv_dat_tnbc &lt;- surv_dat_combine[surv_dat_combine$clinical_type == &quot;TripleNeg&quot;, ]

SurvObj_tnbc &lt;- Surv(surv_dat_tnbc$SurvivalYears, surv_dat_tnbc$Censored)
surv_by_cluster &lt;- survfit(SurvObj_tnbc ~ surv_dat_tnbc$cluster)
surv_by_dataset &lt;- survfit(SurvObj_tnbc ~ surv_dat_tnbc$cluster + surv_dat_tnbc$Dataset)

ggsurvplot(surv_by_cluster, 
           data = surv_dat_tnbc,
           size = 1,                 # change line size
           palette = tableau_color_pal(&quot;Tableau 10&quot;)(10),# custom color palettes
           # conf.int = TRUE,          # Add confidence interval
           pval = TRUE,              # Add p-value
           risk.table = TRUE,        # Add risk table
           risk.table.col = &quot;strata&quot;,# Risk table color by groups
           risk.table.height = 0.25, # Useful to change when you have multiple groups
           ggtheme = theme_bw()      # Change ggplot2 theme
)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-36-1.png" width="1152" /></p>
</div>
</div>
<div id="session-information" class="section level1">
<h1>Session Information</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.6.1 (2019-07-05)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Catalina 10.15.3
## 
## Matrix products: default
## BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_AU.UTF-8/en_AU.UTF-8/en_AU.UTF-8/C/en_AU.UTF-8/en_AU.UTF-8
## 
## attached base packages:
## [1] stats4    parallel  stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] RColorBrewer_1.1-2          survminer_0.4.6            
##  [3] ggpubr_0.2.4                magrittr_1.5               
##  [5] survival_3.1-8              stringr_1.4.0              
##  [7] pheatmap_1.0.12             maptools_0.9-9             
##  [9] sf_0.8-1                    preprocessCore_1.48.0      
## [11] scattermore_0.6             uwot_0.1.4                 
## [13] Matrix_1.2-18               data.table_1.12.6          
## [15] SpatEntropy_0.1.0           spatstat_1.63-3            
## [17] rpart_4.1-15                nlme_3.1-141               
## [19] spatstat.data_1.4-3         gridExtra_2.3              
## [21] ggridges_0.5.1              raster_3.0-7               
## [23] sp_1.3-2                    plyr_1.8.4                 
## [25] ggthemes_4.2.0              scater_1.14.4              
## [27] ggplot2_3.2.1               SingleCellExperiment_1.8.0 
## [29] SummarizedExperiment_1.16.0 DelayedArray_0.12.0        
## [31] BiocParallel_1.20.0         matrixStats_0.55.0         
## [33] Biobase_2.46.0              GenomicRanges_1.38.0       
## [35] GenomeInfoDb_1.22.0         IRanges_2.20.1             
## [37] S4Vectors_0.24.3            BiocGenerics_0.32.0        
## 
## loaded via a namespace (and not attached):
##  [1] ggbeeswarm_0.6.0         colorspace_1.4-1        
##  [3] ggsignif_0.6.0           deldir_0.1-25           
##  [5] class_7.3-15             rsconnect_0.8.15        
##  [7] rgdal_1.4-8              XVector_0.26.0          
##  [9] fftwtools_0.9-8          BiocNeighbors_1.4.1     
## [11] fs_1.3.1                 rstudioapi_0.10         
## [13] farver_2.0.1             rstan_2.19.2            
## [15] RSpectra_0.16-0          codetools_0.2-16        
## [17] splines_3.6.1            knitr_1.26              
## [19] zeallot_0.1.0            polyclip_1.10-0         
## [21] packrat_0.5.0            km.ci_0.5-2             
## [23] broom_0.5.2              compiler_3.6.1          
## [25] backports_1.1.5          assertthat_0.2.1        
## [27] lazyeval_0.2.2           cli_1.1.0               
## [29] BiocSingular_1.2.0       prettyunits_1.0.2       
## [31] htmltools_0.4.0          tools_3.6.1             
## [33] rsvd_1.0.2               gtable_0.3.0            
## [35] glue_1.3.1               GenomeInfoDbData_1.2.2  
## [37] dplyr_0.8.3              Rcpp_1.0.3              
## [39] pkgdown_1.4.1            vctrs_0.2.0             
## [41] DelayedMatrixStats_1.8.0 xfun_0.11               
## [43] ps_1.3.0                 lifecycle_0.1.0         
## [45] irlba_2.3.3              goftest_1.2-2           
## [47] zoo_1.8-6                zlibbioc_1.32.0         
## [49] MASS_7.3-51.4            scales_1.1.0            
## [51] spatstat.utils_1.17-0    inline_0.3.15           
## [53] yaml_2.2.0               memoise_1.1.0           
## [55] KMsurv_0.1-5             loo_2.1.0               
## [57] StanHeaders_2.19.0       stringi_1.4.3           
## [59] e1071_1.7-3              pkgbuild_1.0.6          
## [61] rlang_0.4.2              pkgconfig_2.0.3         
## [63] bitops_1.0-6             evaluate_0.14           
## [65] lattice_0.20-38          purrr_0.3.3             
## [67] tensor_1.5               labeling_0.3            
## [69] cowplot_1.0.0            tidyselect_0.2.5        
## [71] processx_3.4.1           RcppAnnoy_0.0.14        
## [73] R6_2.4.1                 generics_0.0.2          
## [75] DBI_1.0.0                pillar_1.4.2            
## [77] foreign_0.8-72           withr_2.1.2             
## [79] mgcv_1.8-28              units_0.6-5             
## [81] abind_1.4-5              RCurl_1.95-4.12         
## [83] tibble_2.1.3             crayon_1.3.4            
## [85] survMisc_0.5.5           KernSmooth_2.23-15      
## [87] rmarkdown_1.18           viridis_0.5.1           
## [89] grid_3.6.1               callr_3.3.2             
## [91] digest_0.6.23            classInt_0.4-2          
## [93] xtable_1.8-4             tidyr_1.0.0             
## [95] RcppParallel_4.4.4       munsell_0.5.0           
## [97] beeswarm_0.2.3           viridisLite_0.3.0       
## [99] vipor_0.4.5</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
