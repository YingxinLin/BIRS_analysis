<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Preliminary Analysis</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">BIRS analysis</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Overview</a>
</li>
<li>
  <a href="preliminary.html">Preliminary Analysis</a>
</li>
<li>
  <a href="spatial_features.html">Spatial Features</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Preliminary Analysis</h1>

</div>


<div id="data" class="section level1">
<h1>Data</h1>
<pre class="r"><code>library(scater)
library(SingleCellExperiment)
library(ggthemes)
library(ggplot2)
library(ggridges)
library(plyr)
library(raster)
library(gridExtra)
library(sp)
library(spatstat)
library(uwot)
library(pheatmap)
source(&quot;functions/image_analysis_function.R&quot;)
set.seed(2020)</code></pre>
<div id="keren-et-al." class="section level2">
<h2>Keren et al.</h2>
<pre class="r"><code>load(&quot;../../sc-targeted-proteomics/data/mibiSCE.rda&quot;)
mibi.sce</code></pre>
<pre><code>## class: SingleCellExperiment 
## dim: 49 201656 
## metadata(0):
## assays(1): mibi_exprs
## rownames(49): C Na ... Ta Au
## rowData names(4): channel_name is_protein hgnc_symbol wagner_overlap
## colnames: NULL
## colData names(36): SampleID cellLabelInImage ...
##   Survival_days_capped_2016.1.1 Censored
## reducedDimNames(0):
## spikeNames(0):
## altExpNames(0):</code></pre>
<pre class="r"><code>cat(&quot;Patients information&quot;)</code></pre>
<pre><code>## Patients information</code></pre>
<pre class="r"><code>table(mibi.sce$SampleID)</code></pre>
<pre><code>## 
##    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16 
## 5167 3028 6315 6643 5406 5998 3410 3136 6139 4580 5112 6995 7665 6270 3315 8212 
##   17   18   19   20   21   22   23   24   25   26   27   28   29   31   32   33 
## 7071 5539 4400 5103 5423 3072 4490 4613 2658 5119 4332 6061 4819 3415 5158 2046 
##   34   35   36   37   38   39   40   41   42   43   44 
## 2856 7716 2939 6280 4330 4030 4285 4532 1380 1381 1217</code></pre>
<pre class="r"><code>cat(&quot;Cell types informaton&quot;)</code></pre>
<pre><code>## Cell types informaton</code></pre>
<pre class="r"><code># table(mibi.sce$tumor_group)
# table(mibi.sce$immune_group)

# rename the cell types
mibi.sce$cellTypes &lt;- ifelse(as.character(mibi.sce$immune_group) != &quot;not immune&quot;,
                             as.character(mibi.sce$immune_group),
                             as.character(mibi.sce$tumor_group))

table(mibi.sce$cellTypes)</code></pre>
<pre><code>## 
##                      B                    CD3                    CD4 
##                   9134                   3867                  12443 
##                    CD8                     DC                DC/Mono 
##                  15787                   1275                   5052 
##            Endothelial Keratin-positive tumor            Macrophages 
##                   2089                 102736                  20687 
##       Mesenchymal-like               Mono/Neu            Neutrophils 
##                   8479                   3113                   3020 
##                     NK           Other immune                  Tregs 
##                    674                   6943                   1341 
##                  Tumor           Unidentified 
##                   3177                   1839</code></pre>
<pre class="r"><code>mibi.sce$cellTypes_group &lt;- ifelse(as.character(mibi.sce$immune_group) != &quot;not immune&quot;,
                                   &quot;Micro-environment&quot;,
                                   &quot;Tumour&quot;)

selected_chanel_mibi &lt;- rownames(mibi.sce)[rowData(mibi.sce)$is_protein == 1]</code></pre>
<pre class="r"><code># color for mibi cell types
cellTypes_group_mibi_color &lt;- tableau_color_pal(&quot;Tableau 10&quot;)(length(unique(mibi.sce$cellTypes_group)))
cellTypes_group_mibi_color &lt;- c(cellTypes_group_mibi_color, &quot;black&quot;)
names(cellTypes_group_mibi_color) &lt;- c(unique(mibi.sce$cellTypes_group), &quot;Background&quot;)

cellTypes_mibi_color &lt;- tableau_color_pal(&quot;Classic 20&quot;)(length(unique(mibi.sce$cellTypes)))
cellTypes_mibi_color &lt;- c(cellTypes_mibi_color, &quot;black&quot;)
names(cellTypes_mibi_color) &lt;- c(unique(mibi.sce$cellTypes), &quot;Background&quot;)</code></pre>
<p>Visualising all cells using UMAP</p>
<pre class="r"><code>## Dimension Reduction using UMAP
mibi.sce &lt;- runUMAP(mibi.sce, exprs_values = &quot;mibi_exprs&quot;, 
                    feature_set = selected_chanel_mibi)
g1 &lt;- plotUMAP(mibi.sce, colour_by = &quot;cellTypes&quot;) +
  theme(aspect.ratio = 1)
g2 &lt;- plotUMAP(mibi.sce, colour_by = &quot;cellTypes_group&quot;) +
  theme(aspect.ratio = 1)
g3 &lt;- plotUMAP(mibi.sce, colour_by = &quot;SampleID&quot;) +
  theme(aspect.ratio = 1)

grid.arrange(g1, g2, g3, ncol = 2)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-5-1.png" width="1152" /></p>
<p>Cell type composition</p>
<pre class="r"><code>df_mibi &lt;- data.frame(colData(mibi.sce))

g1 &lt;- ggplot(df_mibi, aes(x = SampleID, fill = cellTypes)) +
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values = cellTypes_mibi_color) +
  theme(legend.position = &quot;right&quot;)

g2 &lt;- ggplot(df_mibi, aes(x = SampleID, fill = cellTypes_group)) +
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values = cellTypes_group_mibi_color) +
  theme(legend.position = &quot;right&quot;)

grid.arrange(g1, g2, ncol = 2)</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-6-1.png" width="1152" /></p>
</div>
<div id="jackson-et-al." class="section level2">
<h2>Jackson et al.</h2>
<pre class="r"><code>source(&quot;basel_preprocessing.R&quot;)</code></pre>
<pre class="r"><code>sc_mat &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_sc_mat.rds&quot;)
pg &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_pg.rds&quot;)
meta &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_meta.rds&quot;)
selected_chanel &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_selected_chanel.rds&quot;)
dim(sc_mat)</code></pre>
<pre><code>## [1] 844498     64</code></pre>
<pre class="r"><code>sc_mat_norm &lt;- apply(sc_mat, 2, scale)</code></pre>
<pre class="r"><code>umap &lt;- uwot::umap(sc_mat_norm[, selected_chanel])
saveRDS(umap, file = &quot;../../sc-targeted-proteomics/output/basel_umap.rds&quot;)</code></pre>
<pre class="r"><code># color for mibi cell types

cellTypes_basel_color &lt;- sort(c(tableau_color_pal(&quot;Classic 20&quot;)(20),
                                tableau_color_pal(&quot;Summer&quot;)(5)))
cellTypes_basel_color &lt;- c(cellTypes_basel_color, &quot;black&quot;)
names(cellTypes_basel_color) &lt;- c(unique(pg$cluster_name), &quot;Background&quot;)</code></pre>
<p>Visualising all cells using UMAP</p>
<pre class="r"><code>basel_umap &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_umap.rds&quot;)
library(scattermore)

pg$UMAP1 &lt;- basel_umap[, 1]
pg$UMAP2 &lt;- basel_umap[, 2]
g1 &lt;- ggplot(pg, aes(x = UMAP1, y = UMAP2, color = cluster_name)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_manual(values = cellTypes_basel_color) +
  labs(color = &quot;Cell Type&quot;)
g1</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-11-1.png" width="1152" /></p>
<pre class="r"><code>g2 &lt;- ggplot(pg, aes(x = UMAP1, y = UMAP2, color = cluster_type)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_tableau() +
  labs(color = &quot;Cell Type&quot;)
g2</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-11-2.png" width="1152" /></p>
<p>Cell type composition</p>
<pre class="r"><code>df_basel &lt;- data.frame(pg)

g1 &lt;- ggplot(df_basel, aes(x = core, fill = cluster_name)) +
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values = cellTypes_basel_color) +
  theme(legend.position = &quot;right&quot;,
        axis.text.x = element_blank())
g1</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-12-1.png" width="1152" /></p>
<pre class="r"><code>g2 &lt;- ggplot(df_basel, aes(x = core, fill = cluster_type)) +
  geom_bar() +
  theme_bw() +
  scale_fill_tableau() +
  theme(legend.position = &quot;right&quot;,
        axis.text.x = element_blank())
g2</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-12-2.png" width="1152" /></p>
</div>
</div>
<div id="overlapped-features-between-two-datasets" class="section level1">
<h1>Overlapped features between two datasets</h1>
<pre class="r"><code># intersect(colnames(sc_mat), rownames(mibi.sce))
# colnames(sc_mat)[!colnames(sc_mat) %in% rownames(mibi.sce)]
rownames(mibi.sce)[!rownames(mibi.sce) %in% colnames(sc_mat)]</code></pre>
<pre><code>##  [1] &quot;C&quot;            &quot;Na&quot;           &quot;Si&quot;           &quot;P&quot;            &quot;Ca&quot;          
##  [6] &quot;Fe&quot;           &quot;dsDNA&quot;        &quot;Background&quot;   &quot;B7H3&quot;         &quot;FoxP3&quot;       
## [11] &quot;Lag3&quot;         &quot;CD4&quot;          &quot;CD16&quot;         &quot;CD56&quot;         &quot;OX40&quot;        
## [16] &quot;PD1&quot;          &quot;CD31&quot;         &quot;PD-L1&quot;        &quot;CD209&quot;        &quot;CD11c&quot;       
## [21] &quot;CD138&quot;        &quot;CD163&quot;        &quot;CSF-1R&quot;       &quot;CD8&quot;          &quot;IDO&quot;         
## [26] &quot;Keratin17&quot;    &quot;CD63&quot;         &quot;CD45RO&quot;       &quot;Beta catenin&quot; &quot;HLA-DR&quot;      
## [31] &quot;CD11b&quot;        &quot;H3K9ac&quot;       &quot;Pan-Keratin&quot;  &quot;phospho-S6&quot;   &quot;MPO&quot;         
## [36] &quot;Keratin6&quot;     &quot;HLA_Class_1&quot;  &quot;Ta&quot;           &quot;Au&quot;</code></pre>
<pre class="r"><code>rownames(mibi.sce)[rownames(mibi.sce) == &quot;phospho-S6&quot;] &lt;- &quot;pS6&quot;
rownames(mibi.sce)[rownames(mibi.sce) == &quot;CD31&quot;] &lt;- &quot;vWF&quot;
rownames(mibi.sce)[rownames(mibi.sce) == &quot;Pan-Keratin&quot;] &lt;- &quot;panCK&quot;
common_anti &lt;- intersect(colnames(sc_mat), rownames(mibi.sce))
cat(&quot;Common protein between two datasets&quot;)</code></pre>
<pre><code>## Common protein between two datasets</code></pre>
<pre class="r"><code>common_anti</code></pre>
<pre><code>##  [1] &quot;EGFR&quot;     &quot;Ki67&quot;     &quot;SMA&quot;      &quot;Vimentin&quot; &quot;p53&quot;      &quot;panCK&quot;   
##  [7] &quot;CD20&quot;     &quot;vWF&quot;      &quot;H3K27me3&quot; &quot;CD45&quot;     &quot;CD68&quot;     &quot;CD3&quot;     
## [13] &quot;pS6&quot;</code></pre>
<pre class="r"><code>length(common_anti) </code></pre>
<pre><code>## [1] 13</code></pre>
<pre class="r"><code>mibi_exprs &lt;- assay(mibi.sce, &quot;mibi_exprs&quot;)
mibi_exprs_common &lt;- mibi_exprs[common_anti, ]
sc_mat_common &lt;- t(sc_mat_norm[, common_anti])</code></pre>
<pre class="r"><code>umap_common &lt;- uwot::umap(t(sc_mat_common))
saveRDS(umap_common, file = &quot;../../sc-targeted-proteomics/output/basel_umap_common.rds&quot;)

umap_mibi_common &lt;- uwot::umap(t(mibi_exprs_common))
saveRDS(umap_mibi_common, file = &quot;../../sc-targeted-proteomics/output/mibi_umap_common.rds&quot;)</code></pre>
<pre class="r"><code>basel_umap_common &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/basel_umap_common.rds&quot;)

pg$UMAP1_common &lt;- basel_umap_common[, 1]
pg$UMAP2_common &lt;- basel_umap_common[, 2]
g1 &lt;- ggplot(pg, aes(x = UMAP1_common, y = UMAP2_common, color = cluster_name)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_manual(values = cellTypes_basel_color) +
  labs(color = &quot;Cell Type&quot;)
g1</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-16-1.png" width="1152" /></p>
<pre class="r"><code>g2 &lt;- ggplot(pg, aes(x = UMAP1_common, y = UMAP2_common, color = cluster_type)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_tableau() +
  labs(color = &quot;Cell Type&quot;)

g2</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-16-2.png" width="1152" /></p>
<pre class="r"><code>mibi_umap_common &lt;- readRDS(&quot;../../sc-targeted-proteomics/output/mibi_umap_common.rds&quot;)

df_mibi$UMAP1_common &lt;- mibi_umap_common[, 1]
df_mibi$UMAP2_common &lt;- mibi_umap_common[, 2]
g1 &lt;- ggplot(df_mibi, aes(x = UMAP1_common, y = UMAP2_common, color = cellTypes)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_manual(values = cellTypes_mibi_color) +
  labs(color = &quot;Cell Type&quot;)
g1</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-17-1.png" width="1152" /></p>
<pre class="r"><code>g2 &lt;- ggplot(df_mibi, aes(x = UMAP1_common, y = UMAP2_common, color = cellTypes_group)) + 
  geom_scattermore() +
  theme_bw() +
  theme(aspect.ratio = 1) +
  scale_color_tableau() +
  labs(color = &quot;Cell Type&quot;)

g2</code></pre>
<p><img src="preliminary_files/figure-html/unnamed-chunk-17-2.png" width="1152" /></p>
<!-- # Spatial Pattern Analysis -->
<!-- Here we will use two images from Keren et al. and Jackson et al. as examples to show the image extraction procedure (The full image extraction codes are provided in `mibi_spatial_analysis.R` and `basel_spatial_analysis.R`). -->
<!-- ## Keren et al. -->
<!-- ```{r} -->
<!-- tiff_name_list <- list.files("../../sc-targeted-proteomics/data/TNBC_shareCellData/", pattern = ".tiff") -->
<!-- tiff_name_list <- tiff_name_list[-24] #filter p30 -->
<!-- tiff_name_list -->
<!-- ``` -->
<!-- Here we are extracting the spatial pattern features from `p1_labeledcellData.tiff`. -->
<!-- ```{r} -->
<!-- s <- 1 -->
<!-- str_name <- paste("../../sc-targeted-proteomics/data/TNBC_shareCellData/", tiff_name_list[s], sep = "") -->
<!-- sample_id <- as.numeric(gsub("p", "", gsub("_labeledcellData.tiff", "", tiff_name_list[s]))) -->
<!-- cat(paste0("Reading the tiff ", print(tiff_name_list[s]))) -->
<!-- # read tiff data using raster -->
<!-- r <- raster(str_name) -->
<!-- r -->
<!-- p_sce <- mibi.sce[, mibi.sce$SampleID == sample_id] -->
<!-- # matching the cell label in SingleCellExperiment with the raster position -->
<!-- cell_label <- raster::values(r) -->
<!-- all_group_info <- p_sce$cellTypes_group -->
<!-- notInLabel <- unique(cell_label[!cell_label %in% p_sce$cellLabelInImage]) -->
<!-- new_values <- mapvalues((cell_label), from = notInLabel, to = rep("Background", -->
<!--                                                                   length(notInLabel))) -->
<!-- new_values <- mapvalues((new_values), from = p_sce$cellLabelInImage, to = all_group_info) -->
<!-- new_values_cellTypes <- mapvalues((cell_label), from = notInLabel, to = rep("Background", -->
<!--                                                                             length(notInLabel))) -->
<!-- new_values_cellTypes <- mapvalues((new_values_cellTypes), from = p_sce$cellLabelInImage, to = p_sce$cellTypes) -->
<!-- ``` -->
<!-- ```{r fig.height=8} -->
<!-- ddf <- rasterToPoints(r) -->
<!-- ddf <- data.frame(ddf) -->
<!-- colnames(ddf) <- c("X", "Y", "value") -->
<!-- ddf$cellType_group <- new_values -->
<!-- ddf$cellType <- new_values_cellTypes -->
<!-- g_cellGroup <- ggplot(NULL) +  -->
<!--   geom_raster(data = ddf, aes(X, Y, fill = as.factor(cellType_group))) + -->
<!--   theme_minimal() + -->
<!--   scale_fill_manual(values = cellTypes_group_mibi_color) + -->
<!--   coord_quickmap() + -->
<!--   theme(aspect.ratio = 1, legend.position = "right") + -->
<!--   labs(fill = "Cell Type") -->
<!-- g_cellTypes <- ggplot(NULL) +  -->
<!--   geom_raster(data = ddf, aes(X, Y, fill = as.factor(cellType))) + -->
<!--   theme_minimal() + -->
<!--   scale_fill_manual(values = cellTypes_mibi_color) + -->
<!--   coord_quickmap() + -->
<!--   theme(aspect.ratio = 1, legend.position = "right") + -->
<!--   labs(fill = "Cell Type") -->
<!-- grid.arrange(g_cellGroup, g_cellTypes, ncol = 2) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- # extract the location and identify the cell centroid -->
<!-- coord_r <- rasterToPoints(r) -->
<!-- center_r_x <- aggregate(coord_r[, 1], list(coord_r[, 3]), median) -->
<!-- group <- center_r_x$Group.1 -->
<!-- center_r_x <- center_r_x$x -->
<!-- center_r_y <- aggregate(coord_r[, 2], list(coord_r[, 3]), median)$x -->
<!-- center_r <- data.frame(x = center_r_x, y = center_r_y, group = group) -->
<!-- ## maping the cell types to the raster -->
<!-- r_cellType_group <- mapvalues((center_r$group), from = notInLabel, to = rep(0, length(notInLabel))) -->
<!-- r_cellType_group <- mapvalues((r_cellType_group), from = p_sce$cellLabelInImage, to = all_group_info) -->
<!-- center_r$cellTypes <- r_cellType_group -->
<!-- r_cellType <- mapvalues((center_r$group), from = notInLabel, to = rep(0, length(notInLabel))) -->
<!-- r_cellType <- mapvalues((r_cellType), from = p_sce$cellLabelInImage, to = p_sce$cellTypes) -->
<!-- center_r$cellTypes2 <- r_cellType -->
<!-- # filter the center info without cells  -->
<!-- center_r <- center_r[center_r$cellTypes != "0", ] -->
<!-- r_cellType_group <- mapvalues((center_r$group),  -->
<!--                               from = notInLabel,  -->
<!--                               to = rep(0, length(notInLabel))) -->
<!-- exprsMat <- assay(p_sce, "mibi_exprs") -->
<!-- exprsMat_map <- sapply(rownames(exprsMat), function(x) { -->
<!--   zero_one_scale(mapvalues((r_cellType_group),  -->
<!--                            from = p_sce$cellLabelInImage,  -->
<!--                            to = exprsMat[x, ])) -->
<!-- }) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- # create ppp object and extract spatial features -->
<!-- cell_points <- ppp(x = center_r[, 1], y = center_r[, 2], check = FALSE, -->
<!--                    yrange = c(0, 2048), xrange = c(0, 2048), -->
<!--                    marks = as.factor(center_r$cellTypes)) -->
<!-- plot(density(split(cell_points), sigma = 20), ribbon = FALSE) -->
<!-- idx <- center_r$cellTypes == "Tumour" -->
<!-- cell_points_tumour <- ppp(x = center_r[idx, 1], y = center_r[idx, 2], check = FALSE, -->
<!--                           yrange = c(0, 2048), xrange = c(0, 2048)) -->
<!-- idx <- center_r$cellTypes == "Micro-environment" -->
<!-- cell_points_immune <- ppp(x = center_r[idx, 1], y = center_r[idx, 2], check = FALSE, -->
<!--                           yrange = c(0, 2048), xrange = c(0, 2048)) -->
<!-- ann_tumour_k1 <- mean(nndist(cell_points_tumour, k = 1)) -->
<!-- ann_tumour_k3 <- mean(nndist(cell_points_tumour, k = 3)) -->
<!-- ann_tumour_k5 <- mean(nndist(cell_points_tumour, k = 5)) -->
<!-- ann_tumour_k10 <- mean(nndist(cell_points_tumour, k = 10)) -->
<!-- ann_immune_k1 <- mean(nndist(cell_points_immune, k = 1)) -->
<!-- ann_immune_k3 <- mean(nndist(cell_points_immune, k = 3)) -->
<!-- ann_immune_k5 <- mean(nndist(cell_points_immune, k = 5)) -->
<!-- ann_immune_k10 <- mean(nndist(cell_points_immune, k = 10)) -->
<!-- E_pcf_cross <- envelope(cell_points, pcfcross, nsim = 100,  -->
<!--                         correction = "Ripley", savefuns = T, -->
<!--                         global = TRUE, -->
<!--                         r = seq(0,250, 10)) -->
<!-- E_pcf_tumour <- envelope(cell_points[cell_points$marks == 'Tumour'], pcf, nsim = 100,  -->
<!--                          correction = "Ripley", savefuns = T, -->
<!--                          global = TRUE, -->
<!--                          r = seq(0,250, 10)) -->
<!-- E_pcf_immune <- envelope(cell_points[cell_points$marks == "Micro-environment"], pcf, nsim = 100,  -->
<!--                          correction = "Ripley", savefuns = T, -->
<!--                          global = TRUE, -->
<!--                          r = seq(0,250, 10)) -->
<!-- ``` -->
<!-- Patial correlation function for tumour-tumour cells, immune-immune cells and tumour-immune cells -->
<!-- ```{r} -->
<!-- par(mfrow = c(2, 2)) -->
<!-- plot(E_pcf_tumour) -->
<!-- plot(E_pcf_immune) -->
<!-- plot(E_pcf_cross) -->
<!-- ``` -->
<!-- The above plot indicates the pairwise correlation function (pcf) of distance for point patterns in terms of (i) tumour cells, (ii) immune cells, (iii) tumour-immune cells. The grey area here indicates a null distribution generated by permutations. For a certain radius r and the point from the same cell type, a pcf value higher than upper critical boundary of the gray area are indicates that the points are significantly distributed in clusters, while than the lower boundary of the grey area indicates the dispersed distribution of the points.  -->
<!-- For the values that are within the grey area, it indicates the points are spatially randomlly distributed.  -->
<!-- On the other hand, when we comparing the points from two different types, a larger pcf values indicates the two types of points are attracted, and a lower pcf values indicate the points are repulsed. -->
<!-- We can see for this sample, Tumour cells are more likely randomly distributed in spatial context, while immune cells are located as clusters. And the tumour and immune cells are repulsed to each other. -->
<!-- ```{r} -->
<!-- pcf_results <- c(extract_pcf_results(E_pcf_cross, "cross"), -->
<!--                  extract_pcf_results(E_pcf_tumour, "tumour"), -->
<!--                  extract_pcf_results(E_pcf_immune, "immune")) -->
<!-- library(SpatEntropy) -->
<!-- shZ <- shannonX(marks(cell_points)) -->
<!-- #Leibovici’s entropy -->
<!-- dmat <- pairdist(cell_points) -->
<!-- dmat[lower.tri(dmat,diag = TRUE)] <- NA -->
<!-- adjmat <- adj_mat(dmat, dd0 = 0, dd1 = 20) -->
<!-- leib <- leibovici(marks(cell_points), adjmat, ordered = TRUE) -->
<!-- leib_freq <- leib$freq.table$proportion -->
<!-- names(leib_freq) <- paste("leib", leib$freq.table$couple, "freq", sep = "_") -->
<!-- leib_entro <- leib$entropy -->
<!-- names(leib_entro) <- "leib_entropy" -->
<!-- intensity_res <- intensity(cell_points) -->
<!-- names(intensity_res) <- paste("intensity", names(intensity_res)) -->
<!-- marks(cell_points) <- center_r$cellTypes2 -->
<!-- #Leibovici’s entropy -->
<!-- dmat <- pairdist(cell_points) -->
<!-- dmat[lower.tri(dmat,diag = TRUE)] <- NA -->
<!-- adjmat <- adj_mat(dmat, dd0 = 0, dd1 = 20) -->
<!-- leib <- leibovici(marks(cell_points), adjmat, ordered = TRUE) -->
<!-- leib_entro2 <- leib$entropy -->
<!-- names(leib_entro2) <- "leib_entropy_cellTypes" -->
<!-- res_image <- c(intensity_res, shannon = shZ$shannon, leib_entro, leib_entro2,  -->
<!--                pcf_results, -->
<!--                ann_tumour_k1 = ann_tumour_k1, ann_tumour_k3 = ann_tumour_k3,  -->
<!--                ann_tumour_k5 = ann_tumour_k5, ann_tumour_k10 = ann_tumour_k10, -->
<!--                ann_immune_k1 = ann_immune_k1, ann_immune_k3 = ann_immune_k3,  -->
<!--                ann_immune_k5 = ann_immune_k5, ann_immune_k10 = ann_immune_k10) -->
<!-- cat(paste0("Features extracted for", tiff_name_list[s])) -->
<!-- round(res_image, 2) -->
<!-- ``` -->
<!-- ## Jackson et al. -->
<!-- The similar analysis for Jackson et al. Basel cohort -->
<!-- ```{r} -->
<!-- pg$cluster_type2 <- pg$cluster_type -->
<!-- pg$cluster_type2[pg$cluster_type2 %in% c("Endothelial", "Stromal", "Immune")] <- "Micro-environment" -->
<!-- pg$cluster_type2[pg$cluster_type2 %in% c("Epithelial")] <- "Tumour" -->
<!-- table(pg$cluster_type2) -->
<!-- cellTypes_group_basel_color <- tableau_color_pal("Tableau 10")(length(unique(pg$cluster_type2))) -->
<!-- cellTypes_group_basel_color <- c(cellTypes_group_basel_color, "black") -->
<!-- names(cellTypes_group_basel_color) <- c(unique(pg$cluster_type2), "Background") -->
<!-- ``` -->
<!-- ```{r} -->
<!-- tiff_name_list <- list.files("../../sc-targeted-proteomics/data/Nature_cytof/OMEnMasks/Basel_Zuri_masks/", pattern = "Basel") -->
<!-- map_names <- readRDS("../../sc-targeted-proteomics/output/basel_map_file_core_names.rds") -->
<!-- filter_idx <- c(93, 106, 107, 238, 251, 370, 371) -->
<!-- tiff_name_list <- tiff_name_list[-filter_idx] -->
<!-- s <- 333 -->
<!-- str_name <- paste("../../sc-targeted-proteomics/data/Nature_cytof/OMEnMasks/Basel_Zuri_masks/",  -->
<!--                   tiff_name_list[s], sep = "") -->
<!-- r <- raster(str_name) -->
<!-- cell_label <- raster::values(r) -->
<!-- ncells <- length(unique(cell_label)) - 1 -->
<!-- sample_id <- names(which(map_names[, 2] == tiff_name_list[s])) -->
<!-- idx <- which(pg$core == sample_id) -->
<!-- pg_sub <- pg[idx, ] -->
<!-- sc_mat_subset <- sc_mat[idx, ] -->
<!-- ``` -->
<!-- ```{r} -->
<!-- all_group_info <- pg_sub$cluster_type2 -->
<!-- cell_label <- mapvalues(cell_label,  -->
<!--                         from = sort(unique(cell_label[cell_label != 0])), -->
<!--                         to = seq_len(length(unique(cell_label[cell_label != 0])))) -->
<!-- values(r) <- cell_label -->
<!-- new_values <- mapvalues(cell_label, from = 0, to = "Background") -->
<!-- new_values <- mapvalues(new_values, from = seq_len(length(unique(cell_label[cell_label != 0]))), to = all_group_info) -->
<!-- ddf <- rasterToPoints(r) -->
<!-- ddf <- data.frame(ddf) -->
<!-- colnames(ddf) <- c("X", "Y", "value") -->
<!-- ddf$cellType <- new_values -->
<!-- g_cellTypes <- ggplot(NULL) +  -->
<!--   geom_raster(data = ddf, aes(X, Y, fill = as.factor(cellType))) + -->
<!--   theme_minimal() + -->
<!--   scale_fill_manual(values = cellTypes_group_basel_color) + -->
<!--   coord_quickmap() + -->
<!--   theme(aspect.ratio = 1) + -->
<!--   labs(fill = "Cell Type") -->
<!-- new_values2 <- mapvalues(cell_label, from = 0, to = "Background") -->
<!-- new_values2 <- mapvalues(new_values2, from = seq_len(length(unique(cell_label[cell_label != 0]))), to = pg_sub$cluster_name) -->
<!-- ddf$cellType2 <- new_values2 -->
<!-- g_cellTypes2 <- ggplot(NULL) +  -->
<!--   geom_raster(data = ddf, aes(X, Y, fill = as.factor(cellType2))) + -->
<!--   theme_minimal() + -->
<!--   scale_fill_manual(values = cellTypes_basel_color) + -->
<!--   coord_quickmap() + -->
<!--   theme(aspect.ratio = 1) + -->
<!--   labs(fill = "Cell Type") -->
<!-- grid.arrange(g_cellTypes, g_cellTypes2, nrow = 2) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- coord_r <- rasterToPoints(r) -->
<!-- center_r_x <- aggregate(coord_r[, 1], list(coord_r[, 3]), median) -->
<!-- group <- center_r_x$Group.1 -->
<!-- center_r_x <- center_r_x$x -->
<!-- center_r_y <- aggregate(coord_r[, 2], list(coord_r[, 3]), median)$x -->
<!-- center_r <- data.frame(x = center_r_x, y = center_r_y, group = group) -->
<!-- center_r <- center_r[center_r$group != 0, ] -->
<!-- center_r$cellTypes <- pg_sub$cluster_type2 -->
<!-- center_r$cellTypes2 <- pg_sub$cluster_type -->
<!-- library(sf) -->
<!-- library(maptools) -->
<!-- cell_points <- ppp(x = center_r[, 1], y = center_r[, 2], check = FALSE, -->
<!--                    yrange = c(0, round(max(coord_r[, 2]))),  -->
<!--                    xrange = c(0, round(max(coord_r[, 1]))), -->
<!--                    marks = as.factor(center_r$cellTypes)) -->
<!-- plot(density(split(cell_points), sigma = 20), ribbon = FALSE) -->
<!-- idx <- center_r$cellTypes == "Tumour" -->
<!-- cell_points_tumour <- ppp(x = center_r[idx, 1], y = center_r[idx, 2], check = FALSE, -->
<!--                           yrange = c(0, round(max(coord_r[, 2]))),  -->
<!--                           xrange = c(0, round(max(coord_r[, 1])))) -->
<!-- idx <- center_r$cellTypes == "Micro-environment" -->
<!-- cell_points_immune <- ppp(x = center_r[idx, 1], y = center_r[idx, 2], check = FALSE, -->
<!--                           yrange = c(0, round(max(coord_r[, 2]))),  -->
<!--                           xrange = c(0, round(max(coord_r[, 1])))) -->
<!-- ann_tumour_k1 <- mean(nndist(cell_points_tumour, k = 1)) -->
<!-- ann_tumour_k3 <- mean(nndist(cell_points_tumour, k = 3)) -->
<!-- ann_tumour_k5 <- mean(nndist(cell_points_tumour, k = 5)) -->
<!-- ann_tumour_k10 <- mean(nndist(cell_points_tumour, k = 10)) -->
<!-- ann_immune_k1 <- mean(nndist(cell_points_immune, k = 1)) -->
<!-- ann_immune_k3 <- mean(nndist(cell_points_immune, k = 3)) -->
<!-- ann_immune_k5 <- mean(nndist(cell_points_immune, k = 5)) -->
<!-- ann_immune_k10 <- mean(nndist(cell_points_immune, k = 10)) -->
<!-- E_pcf_cross <- envelope(cell_points, pcfcross, nsim = 100,  -->
<!--                         correction = "Ripley", savefuns = T, -->
<!--                         global = TRUE, -->
<!--                         r = seq(0,250, 10)) -->
<!-- E_pcf_tumour <- envelope(cell_points[cell_points$marks=='Tumour'], pcf, nsim = 100,  -->
<!--                          correction = "Ripley", savefuns = T, -->
<!--                          global = TRUE, -->
<!--                          r = seq(0,250, 10)) -->
<!-- E_pcf_immune <-envelope(cell_points[cell_points$marks=="Micro-environment"], pcf, nsim = 100,  -->
<!--                         correction = "Ripley", savefuns = T, -->
<!--                         global = TRUE, -->
<!--                         r = seq(0,250, 10)) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- par(mfrow = c(2, 2)) -->
<!-- plot(E_pcf_tumour) -->
<!-- plot(E_pcf_immune) -->
<!-- plot(E_pcf_cross) -->
<!-- ``` -->
<!-- We can see for this sample, both tumour cells and immune cells are only forming clusters within a small r, and are randomly spatially distrubted for a larger r. And the tumour and immune cells are spatially independent of each other. -->
<!-- ```{r} -->
<!-- pcf_results <- c(extract_pcf_results(E_pcf_cross, "cross"), -->
<!--                  extract_pcf_results(E_pcf_tumour, "tumour"), -->
<!--                  extract_pcf_results(E_pcf_immune, "immune")) -->
<!-- library(SpatEntropy) -->
<!-- shZ <- shannonX(marks(cell_points)) -->
<!-- #Leibovici’s entropy -->
<!-- dmat <- pairdist(cell_points) -->
<!-- dmat[lower.tri(dmat,diag = TRUE)] <- NA -->
<!-- adjmat <- adj_mat(dmat, dd0 = 0, dd1 = 20) -->
<!-- leib <- leibovici(marks(cell_points), adjmat, ordered=T) -->
<!-- leib_freq <- leib$freq.table$proportion -->
<!-- names(leib_freq) <- paste("leib", leib$freq.table$couple, "freq", sep = "_") -->
<!-- leib_entro <- leib$entropy -->
<!-- names(leib_entro) <- "leib_entropy" -->
<!-- intensity_res <- intensity(cell_points) -->
<!-- if (length(intensity_res) < 2) { -->
<!--   tab <- table(marks(cell_points)) -->
<!--   max_name <- names(tab)[which.max(tab)] -->
<!--   min_name <- names(tab)[which.min(tab)] -->
<!--   intensity_res <- c(intensity_res, 0) -->
<!--   names(intensity_res) <- c(paste("intensity", max_name), -->
<!--                             paste("intensity", min_name)) -->
<!-- } else { -->
<!--   names(intensity_res) <- paste("intensity", names(intensity_res)) -->
<!-- } -->
<!-- marks(cell_points) <- center_r$cellTypes -->
<!-- #Leibovici’s entropy -->
<!-- dmat <- pairdist(cell_points) -->
<!-- dmat[lower.tri(dmat,diag = TRUE)] <- NA -->
<!-- adjmat <- adj_mat(dmat, dd0 = 0, dd1 = 20) -->
<!-- leib <- leibovici(marks(cell_points), adjmat, ordered=T) -->
<!-- leib_entro2 <- leib$entropy -->
<!-- names(leib_entro2) <- "leib_entropy_cellTypes" -->
<!-- res_image <- c(intensity_res, shannon = shZ$shannon, leib_entro, leib_entro2,  -->
<!--                pcf_results, -->
<!--                ann_tumour_k1 = ann_tumour_k1, ann_tumour_k3 = ann_tumour_k3,  -->
<!--                ann_tumour_k5 = ann_tumour_k5, ann_tumour_k10 = ann_tumour_k10, -->
<!--                ann_immune_k1 = ann_immune_k1, ann_immune_k3 = ann_immune_k3,  -->
<!--                ann_immune_k5 = ann_immune_k5, ann_immune_k10 = ann_immune_k10) -->
<!-- round(res_image, 3) -->
<!-- ``` -->
<!-- # Image features -->
<!-- Combine the spatial features from two datasets -->
<!-- ```{r} -->
<!-- image_features <- readRDS("../../sc-targeted-proteomics/output/basel_image_features.rds") -->
<!-- image_features_mibi <- readRDS("../../sc-targeted-proteomics/output/mibi_image_features_forSurv.rds") -->
<!-- meta_mibi <- readRDS("../../sc-targeted-proteomics/output/mibi_meta_forSurv.rds") -->
<!-- meta_filter <- meta[meta$core %in% rownames(image_features), ] -->
<!-- image_features <- image_features -->
<!-- image_features[is.infinite(image_features)] <- 0 -->
<!-- # we will only keep the data with more than 1000 celss -->
<!-- tab_core <- table(pg$core) -->
<!-- core_to_keep <- names(tab_core)[which(tab_core >= 1000)] -->
<!-- image_features_subset <- image_features[core_to_keep, ] -->
<!-- meta_filter <- meta[meta$core %in% core_to_keep, ] -->
<!-- # for patient with more than 1 sample,  -->
<!-- # we will only keep the sample with more cells *for now* -->
<!-- multi_sample_pid <- names(which(table(meta_filter$PID) > 1)) -->
<!-- not_keep <- c() -->
<!-- for (i in 1:length(multi_sample_pid)) { -->
<!--   tab_tmp <- tab_core[meta_filter[meta_filter$PID == multi_sample_pid[i],]$core] -->
<!--   not_keep <- append(not_keep, names(tab_tmp)[-which.max(tab_tmp)]) -->
<!-- } -->
<!-- meta_filter <- meta_filter[!meta_filter$core %in% not_keep, ] -->
<!-- image_features_subset <- image_features_subset[!rownames(image_features_subset) %in% not_keep, ] -->
<!-- # combine two image features -->
<!-- image_features_comb <- rbind(image_features_subset, image_features_mibi) -->
<!-- dataset <- c(rep("Basel", nrow(image_features_subset)), -->
<!--              rep("MIBI", nrow(image_features_mibi))) -->
<!-- rownames(image_features_comb) <- paste(dataset, rownames(image_features_comb), sep = "_") -->
<!-- # scale the features within each dataset, and recombine them -->
<!-- image_features_combine_scale <- rbind(apply(image_features_subset[, !grepl("max_sig|pcf_sig|max_r", colnames(image_features_subset))] -->
<!--                                             , 2, zero_one_scale), -->
<!--                                       apply(image_features_mibi[, !grepl("max_sig|pcf_sig|max_r", colnames(image_features_subset))] -->
<!--                                             , 2, zero_one_scale)) -->
<!-- rownames(image_features_combine_scale) <- rownames(image_features_comb) -->
<!-- ``` -->
<!-- Clustering on the spatial features using hierarchical clustering -->
<!-- ```{r} -->
<!-- hclust_res <- hclust(dist(image_features_combine_scale),  -->
<!--                      method = "ward.D2") -->
<!-- hclust_cluster <- cutree(hclust_res, k = 5) -->
<!-- names(hclust_cluster) <- rownames(image_features_comb) -->
<!-- table(hclust_cluster, dataset) -->
<!-- ``` -->
<!-- Heatmap of the spatial features -->
<!-- ```{r} -->
<!-- col_anno <- data.frame(cluster = as.factor(hclust_cluster), -->
<!--                        dataset = dataset) -->
<!-- rownames(col_anno) <- rownames(image_features_combine_scale) -->
<!-- color_anno <- list(cluster = tableau_color_pal("Tableau 10")(10), -->
<!--                    dataset = tableau_color_pal("Classic 10")(2)) -->
<!-- names(color_anno$cluster) <- levels(col_anno$cluster) -->
<!-- names(color_anno$dataset) <- levels(col_anno$dataset) -->
<!-- p <- pheatmap(image_features_combine_scale,  -->
<!--               clustering_method = "ward.D2", -->
<!--               annotation_row = col_anno, -->
<!--               annotation_colors = color_anno, -->
<!--               show_rownames = FALSE) -->
<!-- show(p) -->
<!-- ``` -->
<!-- # Survival analysis -->
<!-- In this section, we will analysis the survival of the five spatial subtypes we identified from the previous section. -->
<!-- ## Overall -->
<!-- ```{r} -->
<!-- library(stringr) -->
<!-- library(survival) -->
<!-- library(survminer) -->
<!-- library(RColorBrewer) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- # survival data for Keren et al. -->
<!-- surv_dat_mibi <- cbind(meta_mibi[, c('SampleID',  -->
<!--                                      'Survival_days_capped_2016.1.1', -->
<!--                                      'Censored')]) -->
<!-- colnames(surv_dat_mibi) <- c("PID", "SurvivalDays", "Censored") -->
<!-- surv_dat_mibi$PID_dataset <- paste("MIBI", surv_dat_mibi$PID, sep = "_") -->
<!-- surv_dat_mibi$clinical_type <- "TripleNeg" -->
<!-- surv_dat_mibi$SurvivalYears <- surv_dat_mibi$SurvivalDays/365 -->
<!-- surv_dat_mibi$Dataset <- "MIBI" -->
<!-- # survival data for Jackson et al. -->
<!-- surv_dat_basel <- meta_filter[, c('core', 'OSmonth','Patientstatus','clinical_type')] -->
<!-- surv_dat_basel$PID_dataset <- paste("Basel", surv_dat_basel$core, sep = "_") -->
<!-- surv_dat_basel$Censored[str_detect(surv_dat_basel$Patientstatus,'death by primary disease|death')] <- 1 -->
<!-- surv_dat_basel$Censored[is.na(surv_dat_basel$Censored)] <- 0 -->
<!-- surv_dat_basel$SurvivalYears <- surv_dat_basel$OSmonth/12 -->
<!-- surv_dat_basel$Dataset <- "Basel" -->
<!-- surv_dat_combine <- rbind(surv_dat_basel[, c("PID_dataset", "clinical_type",  -->
<!--                                              "Censored", "SurvivalYears", "Dataset")], -->
<!--                           surv_dat_mibi[, c("PID_dataset", "clinical_type",  -->
<!--                                             "Censored", "SurvivalYears", "Dataset")]) -->
<!-- surv_dat_combine$cluster <- hclust_cluster[surv_dat_combine$PID_dataset] -->
<!-- SurvObj_combine <- Surv(surv_dat_combine$SurvivalYears, surv_dat_combine$Censored) -->
<!-- surv_by_cluster <- survfit(SurvObj_combine ~ surv_dat_combine$cluster) -->
<!-- surv_by_clinical_cluster <- survfit(SurvObj_combine ~ surv_dat_combine$cluster + surv_dat_combine$clinical_type) -->
<!-- ggsurvplot(surv_by_cluster,  -->
<!--            data = surv_dat_combine, -->
<!--            size = 1,                 # change line size -->
<!--            palette = tableau_color_pal("Tableau 10")(10),# custom color palettes -->
<!--            # conf.int = TRUE,          # Add confidence interval -->
<!--            pval = TRUE,              # Add p-value -->
<!--            risk.table = TRUE,        # Add risk table -->
<!--            risk.table.col = "strata",# Risk table color by groups -->
<!--            risk.table.height = 0.25, # Useful to change when you have multiple groups -->
<!--            ggtheme = theme_bw()      # Change ggplot2 theme -->
<!-- ) -->
<!-- ggsurvplot(surv_by_clinical_cluster,  -->
<!--            data = surv_dat_combine, -->
<!--            size = 1,                 # change line size -->
<!--            # palette = tableau_color_pal("Tableau 10")(10),# custom color palettes -->
<!--            # conf.int = TRUE,          # Add confidence interval -->
<!--            pval = TRUE,              # Add p-value -->
<!--            risk.table = TRUE,        # Add risk table -->
<!--            risk.table.col = "strata",# Risk table color by groups -->
<!--            risk.table.height = 0.25, # Useful to change when you have multiple groups -->
<!--            ggtheme = theme_bw()      # Change ggplot2 theme -->
<!-- ) -->
<!-- ``` -->
<!-- ## Survival analysis for triple negative breast cancer -->
<!-- ```{r} -->
<!-- surv_dat_tnbc <- surv_dat_combine[surv_dat_combine$clinical_type == "TripleNeg", ] -->
<!-- SurvObj_tnbc <- Surv(surv_dat_tnbc$SurvivalYears, surv_dat_tnbc$Censored) -->
<!-- surv_by_cluster <- survfit(SurvObj_tnbc ~ surv_dat_tnbc$cluster) -->
<!-- ggsurvplot(surv_by_cluster,  -->
<!--            data = surv_dat_tnbc, -->
<!--            size = 1,                 # change line size -->
<!--            palette = tableau_color_pal("Tableau 10")(10),# custom color palettes -->
<!--            # conf.int = TRUE,          # Add confidence interval -->
<!--            pval = TRUE,              # Add p-value -->
<!--            risk.table = TRUE,        # Add risk table -->
<!--            risk.table.col = "strata",# Risk table color by groups -->
<!--            risk.table.height = 0.25, # Useful to change when you have multiple groups -->
<!--            ggtheme = theme_bw()      # Change ggplot2 theme -->
<!-- ) -->
<!-- ``` -->
</div>
<div id="session-information" class="section level1">
<h1>Session Information</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.6.1 (2019-07-05)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Catalina 10.15.4
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_AU.UTF-8/en_AU.UTF-8/en_AU.UTF-8/C/en_AU.UTF-8/en_AU.UTF-8
## 
## attached base packages:
## [1] stats4    parallel  stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] RColorBrewer_1.1-2          survminer_0.4.6            
##  [3] ggpubr_0.2.4                magrittr_1.5               
##  [5] survival_3.1-8              stringr_1.4.0              
##  [7] pheatmap_1.0.12             maptools_0.9-9             
##  [9] sf_0.8-1                    preprocessCore_1.48.0      
## [11] scattermore_0.6             uwot_0.1.4                 
## [13] Matrix_1.2-18               data.table_1.12.6          
## [15] SpatEntropy_0.1.0           spatstat_1.63-3            
## [17] rpart_4.1-15                nlme_3.1-141               
## [19] spatstat.data_1.4-3         gridExtra_2.3              
## [21] ggridges_0.5.1              raster_3.0-7               
## [23] sp_1.3-2                    plyr_1.8.4                 
## [25] ggthemes_4.2.0              scater_1.13.7              
## [27] ggplot2_3.2.1               SingleCellExperiment_1.8.0 
## [29] SummarizedExperiment_1.16.0 DelayedArray_0.12.0        
## [31] BiocParallel_1.20.0         matrixStats_0.55.0         
## [33] Biobase_2.46.0              GenomicRanges_1.38.0       
## [35] GenomeInfoDb_1.22.0         IRanges_2.20.1             
## [37] S4Vectors_0.24.3            BiocGenerics_0.32.0        
## 
## loaded via a namespace (and not attached):
##  [1] ggbeeswarm_0.6.0         colorspace_1.4-1         ggsignif_0.6.0          
##  [4] deldir_0.1-25            class_7.3-15             XVector_0.26.0          
##  [7] BiocNeighbors_1.4.1      rstudioapi_0.10          farver_2.0.1            
## [10] RSpectra_0.16-0          codetools_0.2-16         splines_3.6.1           
## [13] knitr_1.26               polyclip_1.10-0          zeallot_0.1.0           
## [16] broom_0.5.2              km.ci_0.5-2              compiler_3.6.1          
## [19] backports_1.1.5          assertthat_0.2.1         lazyeval_0.2.2          
## [22] BiocSingular_1.2.0       htmltools_0.4.0          tools_3.6.1             
## [25] rsvd_1.0.2               gtable_0.3.0             glue_1.3.1              
## [28] GenomeInfoDbData_1.2.2   dplyr_0.8.3              Rcpp_1.0.3              
## [31] vctrs_0.2.0              DelayedMatrixStats_1.8.0 xfun_0.11               
## [34] lifecycle_0.1.0          irlba_2.3.3              goftest_1.2-2           
## [37] zoo_1.8-6                zlibbioc_1.32.0          scales_1.1.0            
## [40] spatstat.utils_1.17-0    yaml_2.2.0               KMsurv_0.1-5            
## [43] stringi_1.4.3            e1071_1.7-3              rlang_0.4.2             
## [46] pkgconfig_2.0.3          bitops_1.0-6             evaluate_0.14           
## [49] lattice_0.20-38          purrr_0.3.3              tensor_1.5              
## [52] labeling_0.3             cowplot_1.0.0            tidyselect_0.2.5        
## [55] RcppAnnoy_0.0.14         R6_2.4.1                 generics_0.0.2          
## [58] DBI_1.0.0                pillar_1.4.2             foreign_0.8-72          
## [61] withr_2.1.2              mgcv_1.8-28              units_0.6-5             
## [64] abind_1.4-5              RCurl_1.95-4.12          tibble_2.1.3            
## [67] crayon_1.3.4             survMisc_0.5.5           KernSmooth_2.23-15      
## [70] rmarkdown_1.18           viridis_0.5.1            grid_3.6.1              
## [73] digest_0.6.23            classInt_0.4-2           xtable_1.8-4            
## [76] tidyr_1.0.0              RcppParallel_4.4.4       munsell_0.5.0           
## [79] beeswarm_0.2.3           viridisLite_0.3.0        vipor_0.4.5</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
